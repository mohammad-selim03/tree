generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [vector]
}

// --- Identity Context ---

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String
  role          UserRole  @default(BUYER)
  profile       Json?     // flexible for profile data
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  deletedAt     DateTime?
  
  sessions      Session[]
  seller        Seller?
  orders        Order[]
  reviews       Review[]
  carePlans     AICarePlan[]
  notifications Notification[]
}

enum UserRole {
  BUYER
  SELLER
  ADMIN
}

model Session {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  
  user      User     @relation(fields: [userId], references: [id])
  @@index([userId])
}

// --- Catalog Context ---

model Species {
  id              String   @id @default(uuid())
  scientificName  String   @unique
  commonName      String
  family          String
  careRequirements Json    // structured care data
  hardinessZones  String[]
  imageUrl        String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  listings        Listing[]
}

model Category {
  id              String    @id @default(uuid())
  name            String
  slug            String    @unique
  parentId        String?
  createdAt       DateTime  @default(now())
  
  parent          Category? @relation("CategoryTree", fields: [parentId], references: [id])
  children        Category[] @relation("CategoryTree")
}

// --- Marketplace Context ---

model Seller {
  id            String   @id @default(uuid())
  userId        String   @unique
  businessName  String
  verified      Boolean  @default(false)
  rating        Float    @default(0)
  storefront    Json?    // flexible storefront config
  stripeAccountId String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  deletedAt     DateTime?
  
  user          User     @relation(fields: [userId], references: [id])
  listings      Listing[]
  orders        Order[]
  payouts       Payout[]
}

model Listing {
  id            String        @id @default(uuid())
  sellerId      String
  speciesId     String
  title         String
  description   String        @db.Text
  basePrice     Decimal       @db.Decimal(10, 2)
  inventory     Int           @default(0)
  status        ListingStatus @default(DRAFT)
  viewCount     Int           @default(0)
  metadata      Json?         // SEO, tags, etc.
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  publishedAt   DateTime?
  deletedAt     DateTime?
  
  seller        Seller        @relation(fields: [sellerId], references: [id])
  species       Species       @relation(fields: [speciesId], references: [id])
  images        ListingImage[]
  variants      Variant[]
  orderItems    OrderItem[]
  reviews       Review[]
  
  @@index([sellerId])
  @@index([speciesId])
  @@index([status, publishedAt])
}

enum ListingStatus {
  DRAFT
  ACTIVE
  SOLD_OUT
  FLAGGED
  ARCHIVED
}

model Variant {
  id            String   @id @default(uuid())
  listingId     String
  attributes    Json     // age, size, potType
  priceModifier Decimal  @db.Decimal(10, 2)
  stock         Int      @default(0)
  sku           String?  @unique
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  listing       Listing  @relation(fields: [listingId], references: [id])
  orderItems    OrderItem[]
  
  @@index([listingId])
}

model ListingImage {
  id            String   @id @default(uuid())
  listingId     String
  url           String
  order         Int
  altText       String?
  createdAt     DateTime @default(now())
  
  listing       Listing  @relation(fields: [listingId], references: [id])
  imageAnalysis ImageAnalysis?
  embedding     Embedding?
  
  @@index([listingId])
}

// --- Orders & Payments Context ---

model Order {
  id            String        @id @default(uuid())
  orderNumber   String        @unique // human-readable order ID
  buyerId       String
  sellerId      String
  totalPrice    Decimal       @db.Decimal(10, 2)
  status        OrderStatus   @default(PENDING)
  paymentStatus PaymentStatus @default(PENDING)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  buyer         User          @relation(fields: [buyerId], references: [id])
  seller        Seller        @relation(fields: [sellerId], references: [id])
  items         OrderItem[]
  payment       Payment?
  shipment      Shipment?
  refunds       Refund[]
  
  @@index([buyerId])
  @@index([sellerId])
  @@index([status, createdAt])
}

enum OrderStatus {
  PENDING
  CONFIRMED
  SHIPPED
  DELIVERED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

model OrderItem {
  id          String   @id @default(uuid())
  orderId     String
  listingId   String
  variantId   String?
  quantity    Int
  price       Decimal  @db.Decimal(10, 2) // snapshot price at purchase
  createdAt   DateTime @default(now())
  
  order       Order    @relation(fields: [orderId], references: [id])
  listing     Listing  @relation(fields: [listingId], references: [id])
  variant     Variant? @relation(fields: [variantId], references: [id])
  
  @@index([orderId])
}

model Payment {
  id                    String        @id @default(uuid())
  orderId               String        @unique
  amount                Decimal       @db.Decimal(10, 2)
  currency              String        @default("USD")
  stripePaymentIntentId String        @unique
  status                PaymentStatus @default(PENDING)
  metadata              Json?
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt
  
  order                 Order         @relation(fields: [orderId], references: [id])
}

model Refund {
  id          String   @id @default(uuid())
  orderId     String
  amount      Decimal  @db.Decimal(10, 2)
  reason      String
  status      String
  stripeRefundId String @unique
  createdAt   DateTime @default(now())
  
  order       Order    @relation(fields: [orderId], references: [id])
  
  @@index([orderId])
}

model Payout {
  id              String   @id @default(uuid())
  sellerId        String
  amount          Decimal  @db.Decimal(10, 2)
  stripePayoutId  String   @unique
  status          String
  createdAt       DateTime @default(now())
  
  seller          Seller   @relation(fields: [sellerId], references: [id])
  
  @@index([sellerId])
}

// --- Fulfillment Context ---

model Shipment {
  id                String         @id @default(uuid())
  orderId           String         @unique
  carrier           String?
  trackingNumber    String?
  status            ShipmentStatus @default(PREPARING)
  estimatedDelivery DateTime?
  deliveredAt       DateTime?
  addressId         String
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  
  order             Order          @relation(fields: [orderId], references: [id])
  address           DeliveryAddress @relation(fields: [addressId], references: [id])
  
  @@index([orderId])
}

enum ShipmentStatus {
  PREPARING
  SHIPPED
  IN_TRANSIT
  DELIVERED
  FAILED
}

model DeliveryAddress {
  id        String     @id @default(uuid())
  street    String
  city      String
  state     String
  zip       String
  country   String     @default("USA")
  lat       Float?
  lng       Float?
  createdAt DateTime   @default(now())
  
  shipments Shipment[]
}

// --- AI & ML Services Context ---

model ImageAnalysis {
  id                  String             @id @default(uuid())
  imageId             String             @unique
  predictions         Json               // array of {label, confidence}
  topPrediction       String?
  confidence          Float?
  verificationStatus  VerificationStatus @default(PENDING)
  mismatchReason      String?
  createdAt           DateTime           @default(now())
  
  image               ListingImage       @relation(fields: [imageId], references: [id])
}

enum VerificationStatus {
  PENDING
  VERIFIED
  MISMATCH
  FLAGGED
}

model Embedding {
  id        String        @id @default(uuid())
  imageId   String        @unique
  vector    Unsupported("vector(512)") // pgvector type
  model     String        @default("clip-vit-base-patch32")
  createdAt DateTime      @default(now())
  
  image     ListingImage  @relation(fields: [imageId], references: [id])
  
  @@index([vector], name: "embedding_vector_idx", type: Gist) // Using Gist or HNSW for vector search
}

model AICarePlan {
  id                String   @id @default(uuid())
  userId            String
  speciesId         String?
  schedule          Json     // structured care schedule
  generatedContent  String   @db.Text
  icsFileUrl        String?
  createdAt         DateTime @default(now())
  
  user              User     @relation(fields: [userId], references: [id])
  
  @@index([userId])
}

// --- Notifications Context ---

model Notification {
  id        String             @id @default(uuid())
  userId    String
  type      NotificationType
  channel   Channel
  content   Json
  status    NotificationStatus @default(PENDING)
  sentAt    DateTime?
  createdAt DateTime           @default(now())
  
  user      User     @relation(fields: [userId], references: [id])
  
  @@index([userId, status])
}

enum NotificationType {
  ORDER_UPDATE
  PAYMENT_RECEIVED
  LISTING_FLAGGED
  CARE_REMINDER
  PAYOUT_RECEIVED
}

enum Channel {
  EMAIL
  SMS
  PUSH
  IN_APP
}

enum NotificationStatus {
  PENDING
  SENT
  FAILED
}

// --- Analytics Context ---

model Metric {
  id         String   @id @default(uuid())
  name       String
  value      Float
  dimensions Json     // key-value pairs
  timestamp  DateTime @default(now())
  
  @@index([name, timestamp])
}

model Review {
  id        String   @id @default(uuid())
  userId    String
  listingId String
  rating    Int      // 1-5
  comment   String?  @db.Text
  helpful   Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  user      User     @relation(fields: [userId], references: [id])
  listing   Listing  @relation(fields: [listingId], references: [id])
  
  @@index([listingId])
  @@index([userId])
}
