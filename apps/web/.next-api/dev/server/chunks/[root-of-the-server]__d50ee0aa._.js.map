{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///J:/projects/tree/packages/database/src/index.ts"],"sourcesContent":["import { PrismaClient } from '@prisma/client';\r\n\r\nexport * from '@prisma/client';\r\n\r\nconst globalForPrisma = global as unknown as { prisma: PrismaClient };\r\n\r\nexport const prisma =\r\n    globalForPrisma.prisma ||\r\n    new PrismaClient({\r\n        log: ['query', 'error', 'warn'],\r\n    });\r\n\r\nif (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma;\r\n"],"names":[],"mappings":";;;;AAAA;;;AAIA,MAAM;AAEC,MAAM,SACT,gBAAgB,MAAM,IACtB,IAAI,6IAAY,CAAC;IACb,KAAK;QAAC;QAAS;QAAS;KAAO;AACnC;AAEJ,wCAA2C,gBAAgB,MAAM,GAAG"}},
    {"offset": {"line": 78, "column": 0}, "map": {"version":3,"sources":["file:///J:/projects/tree/packages/core/src/orders/domain/entities/OrderItem.ts"],"sourcesContent":["/**\r\n * OrderItem Entity\r\n * \r\n * Represents an item within an order.\r\n */\r\n\r\nimport { Money } from '../../../marketplace/domain/value-objects/Money';\r\n\r\nexport interface OrderItemProps {\r\n  id: string;\r\n  listingId: string;\r\n  quantity: number;\r\n  unitPrice: Money;\r\n  totalPrice: Money;\r\n  sellerName?: string;\r\n}\r\n\r\nexport class OrderItem {\r\n  private props: OrderItemProps;\r\n\r\n  private constructor(props: OrderItemProps) {\r\n    this.props = props;\r\n  }\r\n\r\n  public static create(props: Omit<OrderItemProps, 'id' | 'totalPrice'>): OrderItem {\r\n    OrderItem.validate(props);\r\n\r\n    // Calculate total price\r\n    const totalPrice = props.unitPrice.multiply(props.quantity);\r\n\r\n    return new OrderItem({\r\n      id: crypto.randomUUID(),\r\n      ...props,\r\n      totalPrice,\r\n    });\r\n  }\r\n\r\n  public static reconstitute(props: OrderItemProps): OrderItem {\r\n    return new OrderItem(props);\r\n  }\r\n\r\n  private static validate(props: Omit<OrderItemProps, 'id' | 'totalPrice'>): void {\r\n    if (!props.listingId || props.listingId.trim().length === 0) {\r\n      throw new Error('Listing ID is required');\r\n    }\r\n\r\n    if (props.quantity <= 0) {\r\n      throw new Error('Quantity must be greater than zero');\r\n    }\r\n\r\n    if (props.quantity > 1000) {\r\n      throw new Error('Quantity cannot exceed 1000 per order');\r\n    }\r\n\r\n    if (props.unitPrice.isZero()) {\r\n      throw new Error('Unit price must be greater than zero');\r\n    }\r\n  }\r\n\r\n  // Getters\r\n  get id(): string {\r\n    return this.props.id;\r\n  }\r\n\r\n  get listingId(): string {\r\n    return this.props.listingId;\r\n  }\r\n\r\n  get quantity(): number {\r\n    return this.props.quantity;\r\n  }\r\n\r\n  get unitPrice(): Money {\r\n    return this.props.unitPrice;\r\n  }\r\n\r\n  get totalPrice(): Money {\r\n    return this.props.totalPrice;\r\n  }\r\n\r\n  get sellerName(): string | undefined {\r\n    return this.props.sellerName;\r\n  }\r\n\r\n  /**\r\n   * Update quantity and recalculate total\r\n   */\r\n  public updateQuantity(newQuantity: number): void {\r\n    if (newQuantity <= 0) {\r\n      throw new Error('Quantity must be greater than zero');\r\n    }\r\n\r\n    if (newQuantity > 1000) {\r\n      throw new Error('Quantity cannot exceed 1000');\r\n    }\r\n\r\n    this.props.quantity = newQuantity;\r\n    this.props.totalPrice = this.props.unitPrice.multiply(newQuantity);\r\n  }\r\n\r\n  public getProps(): OrderItemProps {\r\n    return { ...this.props };\r\n  }\r\n}\r\n"],"names":[],"mappings":"AAAA;;;;CAIC;;;;AAaM,MAAM;IACH,MAAsB;IAE9B,YAAoB,KAAqB,CAAE;QACzC,IAAI,CAAC,KAAK,GAAG;IACf;IAEA,OAAc,OAAO,KAAgD,EAAa;QAChF,UAAU,QAAQ,CAAC;QAEnB,wBAAwB;QACxB,MAAM,aAAa,MAAM,SAAS,CAAC,QAAQ,CAAC,MAAM,QAAQ;QAE1D,OAAO,IAAI,UAAU;YACnB,IAAI,OAAO,UAAU;YACrB,GAAG,KAAK;YACR;QACF;IACF;IAEA,OAAc,aAAa,KAAqB,EAAa;QAC3D,OAAO,IAAI,UAAU;IACvB;IAEA,OAAe,SAAS,KAAgD,EAAQ;QAC9E,IAAI,CAAC,MAAM,SAAS,IAAI,MAAM,SAAS,CAAC,IAAI,GAAG,MAAM,KAAK,GAAG;YAC3D,MAAM,IAAI,MAAM;QAClB;QAEA,IAAI,MAAM,QAAQ,IAAI,GAAG;YACvB,MAAM,IAAI,MAAM;QAClB;QAEA,IAAI,MAAM,QAAQ,GAAG,MAAM;YACzB,MAAM,IAAI,MAAM;QAClB;QAEA,IAAI,MAAM,SAAS,CAAC,MAAM,IAAI;YAC5B,MAAM,IAAI,MAAM;QAClB;IACF;IAEA,UAAU;IACV,IAAI,KAAa;QACf,OAAO,IAAI,CAAC,KAAK,CAAC,EAAE;IACtB;IAEA,IAAI,YAAoB;QACtB,OAAO,IAAI,CAAC,KAAK,CAAC,SAAS;IAC7B;IAEA,IAAI,WAAmB;QACrB,OAAO,IAAI,CAAC,KAAK,CAAC,QAAQ;IAC5B;IAEA,IAAI,YAAmB;QACrB,OAAO,IAAI,CAAC,KAAK,CAAC,SAAS;IAC7B;IAEA,IAAI,aAAoB;QACtB,OAAO,IAAI,CAAC,KAAK,CAAC,UAAU;IAC9B;IAEA,IAAI,aAAiC;QACnC,OAAO,IAAI,CAAC,KAAK,CAAC,UAAU;IAC9B;IAEA;;GAEC,GACD,AAAO,eAAe,WAAmB,EAAQ;QAC/C,IAAI,eAAe,GAAG;YACpB,MAAM,IAAI,MAAM;QAClB;QAEA,IAAI,cAAc,MAAM;YACtB,MAAM,IAAI,MAAM;QAClB;QAEA,IAAI,CAAC,KAAK,CAAC,QAAQ,GAAG;QACtB,IAAI,CAAC,KAAK,CAAC,UAAU,GAAG,IAAI,CAAC,KAAK,CAAC,SAAS,CAAC,QAAQ,CAAC;IACxD;IAEO,WAA2B;QAChC,OAAO;YAAE,GAAG,IAAI,CAAC,KAAK;QAAC;IACzB;AACF"}},
    {"offset": {"line": 159, "column": 0}, "map": {"version":3,"sources":["file:///J:/projects/tree/packages/core/src/orders/domain/value-objects/ShippingAddress.ts"],"sourcesContent":["/**\r\n * ShippingAddress Value Object\r\n * \r\n * Encapsulates shipping address information with validation.\r\n */\r\n\r\nexport interface ShippingAddressProps {\r\n  fullName: string;\r\n  addressLine1: string;\r\n  addressLine2?: string;\r\n  city: string;\r\n  state: string;\r\n  postalCode: string;\r\n  country: string;\r\n  phoneNumber: string;\r\n}\r\n\r\nexport class ShippingAddress {\r\n  private readonly props: ShippingAddressProps;\r\n\r\n  private constructor(props: ShippingAddressProps) {\r\n    this.props = props;\r\n  }\r\n\r\n  public static create(props: ShippingAddressProps): ShippingAddress {\r\n    ShippingAddress.validate(props);\r\n    return new ShippingAddress(props);\r\n  }\r\n\r\n  private static validate(props: ShippingAddressProps): void {\r\n    if (!props.fullName || props.fullName.trim().length === 0) {\r\n      throw new Error('Full name is required');\r\n    }\r\n\r\n    if (props.fullName.length < 2 || props.fullName.length > 100) {\r\n      throw new Error('Full name must be between 2 and 100 characters');\r\n    }\r\n\r\n    if (!props.addressLine1 || props.addressLine1.trim().length === 0) {\r\n      throw new Error('Address line 1 is required');\r\n    }\r\n\r\n    if (!props.city || props.city.trim().length === 0) {\r\n      throw new Error('City is required');\r\n    }\r\n\r\n    if (!props.state || props.state.trim().length === 0) {\r\n      throw new Error('State is required');\r\n    }\r\n\r\n    if (!props.postalCode || props.postalCode.trim().length === 0) {\r\n      throw new Error('Postal code is required');\r\n    }\r\n\r\n    // Validate postal code format (simple validation, can be enhanced)\r\n    if (!/^[A-Z0-9\\s-]{3,10}$/i.test(props.postalCode)) {\r\n      throw new Error('Invalid postal code format');\r\n    }\r\n\r\n    if (!props.country || props.country.trim().length === 0) {\r\n      throw new Error('Country is required');\r\n    }\r\n\r\n    // Validate country code (2-letter ISO code)\r\n    if (!/^[A-Z]{2}$/i.test(props.country)) {\r\n      throw new Error('Country must be a 2-letter ISO code (e.g., US, GB)');\r\n    }\r\n\r\n    if (!props.phoneNumber || props.phoneNumber.trim().length === 0) {\r\n      throw new Error('Phone number is required');\r\n    }\r\n\r\n    // Basic phone number validation\r\n    if (!/^[\\d\\s\\-+()]{7,20}$/.test(props.phoneNumber)) {\r\n      throw new Error('Invalid phone number format');\r\n    }\r\n  }\r\n\r\n  // Getters\r\n  get fullName(): string {\r\n    return this.props.fullName;\r\n  }\r\n\r\n  get addressLine1(): string {\r\n    return this.props.addressLine1;\r\n  }\r\n\r\n  get addressLine2(): string | undefined {\r\n    return this.props.addressLine2;\r\n  }\r\n\r\n  get city(): string {\r\n    return this.props.city;\r\n  }\r\n\r\n  get state(): string {\r\n    return this.props.state;\r\n  }\r\n\r\n  get postalCode(): string {\r\n    return this.props.postalCode;\r\n  }\r\n\r\n  get country(): string {\r\n    return this.props.country.toUpperCase();\r\n  }\r\n\r\n  get phoneNumber(): string {\r\n    return this.props.phoneNumber;\r\n  }\r\n\r\n  /**\r\n   * Get formatted address string\r\n   */\r\n  public getFormattedAddress(): string {\r\n    const lines = [\r\n      this.fullName,\r\n      this.addressLine1,\r\n      this.addressLine2,\r\n      `${this.city}, ${this.state} ${this.postalCode}`,\r\n      this.country,\r\n    ].filter(Boolean);\r\n\r\n    return lines.join('\\n');\r\n  }\r\n\r\n  /**\r\n   * Convert to plain object for persistence\r\n   */\r\n  public toObject(): ShippingAddressProps {\r\n    return { ...this.props };\r\n  }\r\n\r\n  public equals(other: ShippingAddress): boolean {\r\n    return (\r\n      this.addressLine1 === other.addressLine1 &&\r\n      this.city === other.city &&\r\n      this.state === other.state &&\r\n      this.postalCode === other.postalCode &&\r\n      this.country === other.country\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 266, "column": 0}, "map": {"version":3,"sources":["file:///J:/projects/tree/packages/core/src/orders/application/use-cases/CreateOrderUseCase.ts"],"sourcesContent":["/**\r\n * Create Order Use Case\r\n * \r\n * Handles the business logic for creating a new order.\r\n */\r\n\r\nimport { IOrderRepository } from '../../domain/repositories/IOrderRepository';\r\nimport { IListingRepository } from '../../../marketplace/domain/repositories/IListingRepository';\r\nimport { Order } from '../../domain/aggregates/Order';\r\nimport { OrderItem } from '../../domain/entities/OrderItem';\r\nimport { ShippingAddress } from '../../domain/value-objects/ShippingAddress';\r\nimport { CreateOrderDTO, OrderResponseDTO } from '../dtos/OrderDTO';\r\n\r\nexport class CreateOrderUseCase {\r\n  constructor(\r\n    private orderRepository: IOrderRepository,\r\n    private listingRepository: IListingRepository\r\n  ) {}\r\n\r\n  async execute(buyerId: string, dto: CreateOrderDTO): Promise<OrderResponseDTO> {\r\n    // 1. Find and validate listing\r\n    const listing = await this.listingRepository.findById(dto.listingId);\r\n    if (!listing) {\r\n      throw new Error('Listing not found');\r\n    }\r\n\r\n    // 2. Check if listing is available\r\n    if (!listing.isAvailable()) {\r\n      throw new Error('Listing is not available for purchase');\r\n    }\r\n\r\n    // 3. Check inventory\r\n    if (listing.inventory < dto.quantity) {\r\n      throw new Error(`Insufficient inventory. Only ${listing.inventory} items available`);\r\n    }\r\n\r\n    // 4. Create shipping address value object\r\n    const shippingAddress = ShippingAddress.create(dto.shippingAddress);\r\n\r\n    // 5. Create order item\r\n    const orderItem = OrderItem.create({\r\n      listingId: listing.id,\r\n      quantity: dto.quantity,\r\n      unitPrice: listing.basePrice,\r\n    });\r\n\r\n    // 6. Create order\r\n    const order = Order.create({\r\n      buyerId,\r\n      sellerId: listing.sellerId,\r\n      items: [orderItem],\r\n      shippingAddress,\r\n      notes: dto.notes,\r\n    });\r\n\r\n    // 7. Decrease inventory (optimistic)\r\n    listing.decreaseInventory(dto.quantity);\r\n\r\n    // 8. Save order and update listing\r\n    await Promise.all([\r\n      this.orderRepository.save(order),\r\n      this.listingRepository.save(listing),\r\n    ]);\r\n\r\n    // 9. Return response\r\n    return this.toResponseDTO(order);\r\n  }\r\n\r\n  private toResponseDTO(order: Order): OrderResponseDTO {\r\n    return {\r\n      id: order.id,\r\n      orderNumber: order.orderNumber.getValue(),\r\n      buyerId: order.buyerId,\r\n      sellerId: order.sellerId,\r\n      items: order.items.map((item) => ({\r\n        id: item.id,\r\n        listingId: item.listingId,\r\n        quantity: item.quantity,\r\n        unitPrice: item.unitPrice.getAmount(),\r\n        totalPrice: item.totalPrice.getAmount(),\r\n        sellerName: item.sellerName,\r\n      })),\r\n      totalAmount: order.totalAmount.getAmount(),\r\n      currency: order.totalAmount.getCurrency(),\r\n      shippingAddress: order.shippingAddress.toObject(),\r\n      status: order.status,\r\n      paymentIntentId: order.paymentIntentId,\r\n      trackingNumber: order.trackingNumber,\r\n      notes: order.notes,\r\n      createdAt: order.createdAt.toISOString(),\r\n      updatedAt: order.updatedAt.toISOString(),\r\n      paidAt: order.paidAt?.toISOString(),\r\n      shippedAt: order.shippedAt?.toISOString(),\r\n      deliveredAt: order.deliveredAt?.toISOString(),\r\n    };\r\n  }\r\n}\r\n"],"names":[],"mappings":"AAAA;;;;CAIC;;;;AAID;AACA;AACA;;;;AAGO,MAAM;;;IACX,YACE,AAAQ,eAAiC,EACzC,AAAQ,iBAAqC,CAC7C;aAFQ,kBAAA;aACA,oBAAA;IACP;IAEH,MAAM,QAAQ,OAAe,EAAE,GAAmB,EAA6B;QAC7E,+BAA+B;QAC/B,MAAM,UAAU,MAAM,IAAI,CAAC,iBAAiB,CAAC,QAAQ,CAAC,IAAI,SAAS;QACnE,IAAI,CAAC,SAAS;YACZ,MAAM,IAAI,MAAM;QAClB;QAEA,mCAAmC;QACnC,IAAI,CAAC,QAAQ,WAAW,IAAI;YAC1B,MAAM,IAAI,MAAM;QAClB;QAEA,qBAAqB;QACrB,IAAI,QAAQ,SAAS,GAAG,IAAI,QAAQ,EAAE;YACpC,MAAM,IAAI,MAAM,CAAC,6BAA6B,EAAE,QAAQ,SAAS,CAAC,gBAAgB,CAAC;QACrF;QAEA,0CAA0C;QAC1C,MAAM,kBAAkB,uMAAe,CAAC,MAAM,CAAC,IAAI,eAAe;QAElE,uBAAuB;QACvB,MAAM,YAAY,mLAAS,CAAC,MAAM,CAAC;YACjC,WAAW,QAAQ,EAAE;YACrB,UAAU,IAAI,QAAQ;YACtB,WAAW,QAAQ,SAAS;QAC9B;QAEA,kBAAkB;QAClB,MAAM,QAAQ,6KAAK,CAAC,MAAM,CAAC;YACzB;YACA,UAAU,QAAQ,QAAQ;YAC1B,OAAO;gBAAC;aAAU;YAClB;YACA,OAAO,IAAI,KAAK;QAClB;QAEA,qCAAqC;QACrC,QAAQ,iBAAiB,CAAC,IAAI,QAAQ;QAEtC,mCAAmC;QACnC,MAAM,QAAQ,GAAG,CAAC;YAChB,IAAI,CAAC,eAAe,CAAC,IAAI,CAAC;YAC1B,IAAI,CAAC,iBAAiB,CAAC,IAAI,CAAC;SAC7B;QAED,qBAAqB;QACrB,OAAO,IAAI,CAAC,aAAa,CAAC;IAC5B;IAEQ,cAAc,KAAY,EAAoB;QACpD,OAAO;YACL,IAAI,MAAM,EAAE;YACZ,aAAa,MAAM,WAAW,CAAC,QAAQ;YACvC,SAAS,MAAM,OAAO;YACtB,UAAU,MAAM,QAAQ;YACxB,OAAO,MAAM,KAAK,CAAC,GAAG,CAAC,CAAC,OAAS,CAAC;oBAChC,IAAI,KAAK,EAAE;oBACX,WAAW,KAAK,SAAS;oBACzB,UAAU,KAAK,QAAQ;oBACvB,WAAW,KAAK,SAAS,CAAC,SAAS;oBACnC,YAAY,KAAK,UAAU,CAAC,SAAS;oBACrC,YAAY,KAAK,UAAU;gBAC7B,CAAC;YACD,aAAa,MAAM,WAAW,CAAC,SAAS;YACxC,UAAU,MAAM,WAAW,CAAC,WAAW;YACvC,iBAAiB,MAAM,eAAe,CAAC,QAAQ;YAC/C,QAAQ,MAAM,MAAM;YACpB,iBAAiB,MAAM,eAAe;YACtC,gBAAgB,MAAM,cAAc;YACpC,OAAO,MAAM,KAAK;YAClB,WAAW,MAAM,SAAS,CAAC,WAAW;YACtC,WAAW,MAAM,SAAS,CAAC,WAAW;YACtC,QAAQ,MAAM,MAAM,EAAE;YACtB,WAAW,MAAM,SAAS,EAAE;YAC5B,aAAa,MAAM,WAAW,EAAE;QAClC;IACF;AACF"}},
    {"offset": {"line": 362, "column": 0}, "map": {"version":3,"sources":["file:///J:/projects/tree/packages/core/src/orders/application/use-cases/GetOrderHistoryUseCase.ts"],"sourcesContent":["/**\r\n * Get Order History Use Case\r\n * \r\n * Retrieves order history for a user (buyer or seller).\r\n */\r\n\r\nimport { IOrderRepository } from '../../domain/repositories/IOrderRepository';\r\nimport { SearchOrdersDTO, OrderSearchResponseDTO, OrderResponseDTO } from '../dtos/OrderDTO';\r\n\r\nexport class GetOrderHistoryUseCase {\r\n  constructor(private orderRepository: IOrderRepository) {}\r\n\r\n  async execute(userId: string, dto: SearchOrdersDTO, role: 'buyer' | 'seller'): Promise<OrderSearchResponseDTO> {\r\n    const page = dto.page ?? 1;\r\n    const pageSize = dto.pageSize ?? 20;\r\n    const offset = (page - 1) * pageSize;\r\n\r\n    // Build filters based on role\r\n    const filters: any = {\r\n      limit: pageSize,\r\n      offset,\r\n    };\r\n\r\n    if (role === 'buyer') {\r\n      filters.buyerId = userId;\r\n    } else if (role === 'seller') {\r\n      filters.sellerId = userId;\r\n    }\r\n\r\n    if (dto.status) {\r\n      filters.status = dto.status;\r\n    }\r\n\r\n    if (dto.fromDate) {\r\n      filters.fromDate = new Date(dto.fromDate);\r\n    }\r\n\r\n    if (dto.toDate) {\r\n      filters.toDate = new Date(dto.toDate);\r\n    }\r\n\r\n    // Execute search\r\n    const result = await this.orderRepository.search(filters);\r\n\r\n    // Calculate total pages\r\n    const totalPages = Math.ceil(result.total / pageSize);\r\n\r\n    // Map to response DTOs\r\n    const orders = result.orders.map((order) => this.toResponseDTO(order));\r\n\r\n    return {\r\n      orders,\r\n      total: result.total,\r\n      page,\r\n      pageSize,\r\n      totalPages,\r\n    };\r\n  }\r\n\r\n  private toResponseDTO(order: any): OrderResponseDTO {\r\n    return {\r\n      id: order.id,\r\n      orderNumber: order.orderNumber.getValue(),\r\n      buyerId: order.buyerId,\r\n      sellerId: order.sellerId,\r\n      items: order.items.map((item: any) => ({\r\n        id: item.id,\r\n        listingId: item.listingId,\r\n        quantity: item.quantity,\r\n        unitPrice: item.unitPrice.getAmount(),\r\n        totalPrice: item.totalPrice.getAmount(),\r\n        sellerName: item.sellerName,\r\n      })),\r\n      totalAmount: order.totalAmount.getAmount(),\r\n      currency: order.totalAmount.getCurrency(),\r\n      shippingAddress: order.shippingAddress.toObject(),\r\n      status: order.status,\r\n      paymentIntentId: order.paymentIntentId,\r\n      trackingNumber: order.trackingNumber,\r\n      notes: order.notes,\r\n      createdAt: order.createdAt.toISOString(),\r\n      updatedAt: order.updatedAt.toISOString(),\r\n      paidAt: order.paidAt?.toISOString(),\r\n      shippedAt: order.shippedAt?.toISOString(),\r\n      deliveredAt: order.deliveredAt?.toISOString(),\r\n    };\r\n  }\r\n}\r\n"],"names":[],"mappings":"AAAA;;;;CAIC;;;;AAKM,MAAM;;IACX,YAAY,AAAQ,eAAiC,CAAE;aAAnC,kBAAA;IAAoC;IAExD,MAAM,QAAQ,MAAc,EAAE,GAAoB,EAAE,IAAwB,EAAmC;QAC7G,MAAM,OAAO,IAAI,IAAI,IAAI;QACzB,MAAM,WAAW,IAAI,QAAQ,IAAI;QACjC,MAAM,SAAS,CAAC,OAAO,CAAC,IAAI;QAE5B,8BAA8B;QAC9B,MAAM,UAAe;YACnB,OAAO;YACP;QACF;QAEA,IAAI,SAAS,SAAS;YACpB,QAAQ,OAAO,GAAG;QACpB,OAAO,IAAI,SAAS,UAAU;YAC5B,QAAQ,QAAQ,GAAG;QACrB;QAEA,IAAI,IAAI,MAAM,EAAE;YACd,QAAQ,MAAM,GAAG,IAAI,MAAM;QAC7B;QAEA,IAAI,IAAI,QAAQ,EAAE;YAChB,QAAQ,QAAQ,GAAG,IAAI,KAAK,IAAI,QAAQ;QAC1C;QAEA,IAAI,IAAI,MAAM,EAAE;YACd,QAAQ,MAAM,GAAG,IAAI,KAAK,IAAI,MAAM;QACtC;QAEA,iBAAiB;QACjB,MAAM,SAAS,MAAM,IAAI,CAAC,eAAe,CAAC,MAAM,CAAC;QAEjD,wBAAwB;QACxB,MAAM,aAAa,KAAK,IAAI,CAAC,OAAO,KAAK,GAAG;QAE5C,uBAAuB;QACvB,MAAM,SAAS,OAAO,MAAM,CAAC,GAAG,CAAC,CAAC,QAAU,IAAI,CAAC,aAAa,CAAC;QAE/D,OAAO;YACL;YACA,OAAO,OAAO,KAAK;YACnB;YACA;YACA;QACF;IACF;IAEQ,cAAc,KAAU,EAAoB;QAClD,OAAO;YACL,IAAI,MAAM,EAAE;YACZ,aAAa,MAAM,WAAW,CAAC,QAAQ;YACvC,SAAS,MAAM,OAAO;YACtB,UAAU,MAAM,QAAQ;YACxB,OAAO,MAAM,KAAK,CAAC,GAAG,CAAC,CAAC,OAAc,CAAC;oBACrC,IAAI,KAAK,EAAE;oBACX,WAAW,KAAK,SAAS;oBACzB,UAAU,KAAK,QAAQ;oBACvB,WAAW,KAAK,SAAS,CAAC,SAAS;oBACnC,YAAY,KAAK,UAAU,CAAC,SAAS;oBACrC,YAAY,KAAK,UAAU;gBAC7B,CAAC;YACD,aAAa,MAAM,WAAW,CAAC,SAAS;YACxC,UAAU,MAAM,WAAW,CAAC,WAAW;YACvC,iBAAiB,MAAM,eAAe,CAAC,QAAQ;YAC/C,QAAQ,MAAM,MAAM;YACpB,iBAAiB,MAAM,eAAe;YACtC,gBAAgB,MAAM,cAAc;YACpC,OAAO,MAAM,KAAK;YAClB,WAAW,MAAM,SAAS,CAAC,WAAW;YACtC,WAAW,MAAM,SAAS,CAAC,WAAW;YACtC,QAAQ,MAAM,MAAM,EAAE;YACtB,WAAW,MAAM,SAAS,EAAE;YAC5B,aAAa,MAAM,WAAW,EAAE;QAClC;IACF;AACF"}},
    {"offset": {"line": 445, "column": 0}, "map": {"version":3,"sources":["file:///J:/projects/tree/packages/core/src/orders/domain/value-objects/OrderNumber.ts"],"sourcesContent":["/**\r\n * OrderNumber Value Object\r\n * \r\n * Generates and validates unique order numbers.\r\n * Format: ORD-YYYYMMDD-XXXXX (e.g., ORD-20251120-A1B2C)\r\n */\r\n\r\nexport class OrderNumber {\r\n  private readonly value: string;\r\n\r\n  private constructor(value: string) {\r\n    this.value = value;\r\n  }\r\n\r\n  /**\r\n   * Generate a new order number\r\n   */\r\n  public static generate(): OrderNumber {\r\n    const date = new Date();\r\n    const dateStr = date.toISOString().slice(0, 10).replace(/-/g, '');\r\n    const randomStr = Math.random().toString(36).substring(2, 7).toUpperCase();\r\n    \r\n    const orderNumber = `ORD-${dateStr}-${randomStr}`;\r\n    return new OrderNumber(orderNumber);\r\n  }\r\n\r\n  /**\r\n   * Create from existing order number (from database)\r\n   */\r\n  public static fromString(orderNumber: string): OrderNumber {\r\n    OrderNumber.validate(orderNumber);\r\n    return new OrderNumber(orderNumber);\r\n  }\r\n\r\n  /**\r\n   * Validate order number format\r\n   */\r\n  private static validate(orderNumber: string): void {\r\n    if (!orderNumber || orderNumber.length === 0) {\r\n      throw new Error('Order number cannot be empty');\r\n    }\r\n\r\n    // Check format: ORD-YYYYMMDD-XXXXX\r\n    const regex = /^ORD-\\d{8}-[A-Z0-9]{5}$/;\r\n    if (!regex.test(orderNumber)) {\r\n      throw new Error('Invalid order number format. Expected: ORD-YYYYMMDD-XXXXX');\r\n    }\r\n  }\r\n\r\n  public getValue(): string {\r\n    return this.value;\r\n  }\r\n\r\n  public equals(other: OrderNumber): boolean {\r\n    return this.value === other.value;\r\n  }\r\n\r\n  public toString(): string {\r\n    return this.value;\r\n  }\r\n}\r\n"],"names":[],"mappings":"AAAA;;;;;CAKC;;;;AAEM,MAAM;IACM,MAAc;IAE/B,YAAoB,KAAa,CAAE;QACjC,IAAI,CAAC,KAAK,GAAG;IACf;IAEA;;GAEC,GACD,OAAc,WAAwB;QACpC,MAAM,OAAO,IAAI;QACjB,MAAM,UAAU,KAAK,WAAW,GAAG,KAAK,CAAC,GAAG,IAAI,OAAO,CAAC,MAAM;QAC9D,MAAM,YAAY,KAAK,MAAM,GAAG,QAAQ,CAAC,IAAI,SAAS,CAAC,GAAG,GAAG,WAAW;QAExE,MAAM,cAAc,CAAC,IAAI,EAAE,QAAQ,CAAC,EAAE,WAAW;QACjD,OAAO,IAAI,YAAY;IACzB;IAEA;;GAEC,GACD,OAAc,WAAW,WAAmB,EAAe;QACzD,YAAY,QAAQ,CAAC;QACrB,OAAO,IAAI,YAAY;IACzB;IAEA;;GAEC,GACD,OAAe,SAAS,WAAmB,EAAQ;QACjD,IAAI,CAAC,eAAe,YAAY,MAAM,KAAK,GAAG;YAC5C,MAAM,IAAI,MAAM;QAClB;QAEA,mCAAmC;QACnC,MAAM,QAAQ;QACd,IAAI,CAAC,MAAM,IAAI,CAAC,cAAc;YAC5B,MAAM,IAAI,MAAM;QAClB;IACF;IAEO,WAAmB;QACxB,OAAO,IAAI,CAAC,KAAK;IACnB;IAEO,OAAO,KAAkB,EAAW;QACzC,OAAO,IAAI,CAAC,KAAK,KAAK,MAAM,KAAK;IACnC;IAEO,WAAmB;QACxB,OAAO,IAAI,CAAC,KAAK;IACnB;AACF"}},
    {"offset": {"line": 500, "column": 0}, "map": {"version":3,"sources":["file:///J:/projects/tree/packages/core/src/marketplace/domain/value-objects/Money.ts"],"sourcesContent":["/**\r\n * Money Value Object\r\n * \r\n * Represents monetary value with currency.\r\n * Ensures money operations are type-safe and currency-aware.\r\n */\r\n\r\nexport class Money {\r\n  private readonly amount: number;\r\n  private readonly currency: string;\r\n\r\n  private constructor(amount: number, currency: string = 'USD') {\r\n    if (amount < 0) {\r\n      throw new Error('Money amount cannot be negative');\r\n    }\r\n    if (!currency || currency.length !== 3) {\r\n      throw new Error('Currency must be a valid 3-letter code');\r\n    }\r\n    this.amount = amount;\r\n    this.currency = currency.toUpperCase();\r\n  }\r\n\r\n  public static create(amount: number, currency: string = 'USD'): Money {\r\n    return new Money(amount, currency);\r\n  }\r\n\r\n  public static zero(currency: string = 'USD'): Money {\r\n    return new Money(0, currency);\r\n  }\r\n\r\n  public getAmount(): number {\r\n    return this.amount;\r\n  }\r\n\r\n  public getCurrency(): string {\r\n    return this.currency;\r\n  }\r\n\r\n  public add(other: Money): Money {\r\n    this.assertSameCurrency(other);\r\n    return Money.create(this.amount + other.amount, this.currency);\r\n  }\r\n\r\n  public subtract(other: Money): Money {\r\n    this.assertSameCurrency(other);\r\n    const result = this.amount - other.amount;\r\n    if (result < 0) {\r\n      throw new Error('Subtraction would result in negative money');\r\n    }\r\n    return Money.create(result, this.currency);\r\n  }\r\n\r\n  public multiply(factor: number): Money {\r\n    if (factor < 0) {\r\n      throw new Error('Cannot multiply money by negative factor');\r\n    }\r\n    return Money.create(this.amount * factor, this.currency);\r\n  }\r\n\r\n  public divide(divisor: number): Money {\r\n    if (divisor <= 0) {\r\n      throw new Error('Cannot divide money by zero or negative number');\r\n    }\r\n    return Money.create(this.amount / divisor, this.currency);\r\n  }\r\n\r\n  public isGreaterThan(other: Money): boolean {\r\n    this.assertSameCurrency(other);\r\n    return this.amount > other.amount;\r\n  }\r\n\r\n  public isLessThan(other: Money): boolean {\r\n    this.assertSameCurrency(other);\r\n    return this.amount < other.amount;\r\n  }\r\n\r\n  public equals(other: Money): boolean {\r\n    return this.amount === other.amount && this.currency === other.currency;\r\n  }\r\n\r\n  public isZero(): boolean {\r\n    return this.amount === 0;\r\n  }\r\n\r\n  public toString(): string {\r\n    return `${this.currency} ${this.amount.toFixed(2)}`;\r\n  }\r\n\r\n  private assertSameCurrency(other: Money): void {\r\n    if (this.currency !== other.currency) {\r\n      throw new Error(\r\n        `Cannot perform operation on different currencies: ${this.currency} and ${other.currency}`\r\n      );\r\n    }\r\n  }\r\n}\r\n"],"names":[],"mappings":"AAAA;;;;;CAKC;;;;AAEM,MAAM;IACM,OAAe;IACf,SAAiB;IAElC,YAAoB,MAAc,EAAE,WAAmB,KAAK,CAAE;QAC5D,IAAI,SAAS,GAAG;YACd,MAAM,IAAI,MAAM;QAClB;QACA,IAAI,CAAC,YAAY,SAAS,MAAM,KAAK,GAAG;YACtC,MAAM,IAAI,MAAM;QAClB;QACA,IAAI,CAAC,MAAM,GAAG;QACd,IAAI,CAAC,QAAQ,GAAG,SAAS,WAAW;IACtC;IAEA,OAAc,OAAO,MAAc,EAAE,WAAmB,KAAK,EAAS;QACpE,OAAO,IAAI,MAAM,QAAQ;IAC3B;IAEA,OAAc,KAAK,WAAmB,KAAK,EAAS;QAClD,OAAO,IAAI,MAAM,GAAG;IACtB;IAEO,YAAoB;QACzB,OAAO,IAAI,CAAC,MAAM;IACpB;IAEO,cAAsB;QAC3B,OAAO,IAAI,CAAC,QAAQ;IACtB;IAEO,IAAI,KAAY,EAAS;QAC9B,IAAI,CAAC,kBAAkB,CAAC;QACxB,OAAO,MAAM,MAAM,CAAC,IAAI,CAAC,MAAM,GAAG,MAAM,MAAM,EAAE,IAAI,CAAC,QAAQ;IAC/D;IAEO,SAAS,KAAY,EAAS;QACnC,IAAI,CAAC,kBAAkB,CAAC;QACxB,MAAM,SAAS,IAAI,CAAC,MAAM,GAAG,MAAM,MAAM;QACzC,IAAI,SAAS,GAAG;YACd,MAAM,IAAI,MAAM;QAClB;QACA,OAAO,MAAM,MAAM,CAAC,QAAQ,IAAI,CAAC,QAAQ;IAC3C;IAEO,SAAS,MAAc,EAAS;QACrC,IAAI,SAAS,GAAG;YACd,MAAM,IAAI,MAAM;QAClB;QACA,OAAO,MAAM,MAAM,CAAC,IAAI,CAAC,MAAM,GAAG,QAAQ,IAAI,CAAC,QAAQ;IACzD;IAEO,OAAO,OAAe,EAAS;QACpC,IAAI,WAAW,GAAG;YAChB,MAAM,IAAI,MAAM;QAClB;QACA,OAAO,MAAM,MAAM,CAAC,IAAI,CAAC,MAAM,GAAG,SAAS,IAAI,CAAC,QAAQ;IAC1D;IAEO,cAAc,KAAY,EAAW;QAC1C,IAAI,CAAC,kBAAkB,CAAC;QACxB,OAAO,IAAI,CAAC,MAAM,GAAG,MAAM,MAAM;IACnC;IAEO,WAAW,KAAY,EAAW;QACvC,IAAI,CAAC,kBAAkB,CAAC;QACxB,OAAO,IAAI,CAAC,MAAM,GAAG,MAAM,MAAM;IACnC;IAEO,OAAO,KAAY,EAAW;QACnC,OAAO,IAAI,CAAC,MAAM,KAAK,MAAM,MAAM,IAAI,IAAI,CAAC,QAAQ,KAAK,MAAM,QAAQ;IACzE;IAEO,SAAkB;QACvB,OAAO,IAAI,CAAC,MAAM,KAAK;IACzB;IAEO,WAAmB;QACxB,OAAO,GAAG,IAAI,CAAC,QAAQ,CAAC,CAAC,EAAE,IAAI,CAAC,MAAM,CAAC,OAAO,CAAC,IAAI;IACrD;IAEQ,mBAAmB,KAAY,EAAQ;QAC7C,IAAI,IAAI,CAAC,QAAQ,KAAK,MAAM,QAAQ,EAAE;YACpC,MAAM,IAAI,MACR,CAAC,kDAAkD,EAAE,IAAI,CAAC,QAAQ,CAAC,KAAK,EAAE,MAAM,QAAQ,EAAE;QAE9F;IACF;AACF"}},
    {"offset": {"line": 585, "column": 0}, "map": {"version":3,"sources":["file:///J:/projects/tree/packages/core/src/orders/infrastructure/repositories/PrismaOrderRepository.ts"],"sourcesContent":["/**\r\n * Prisma Order Repository Implementation\r\n * \r\n * Implements IOrderRepository using Prisma ORM.\r\n */\r\n\r\nimport { PrismaClient } from '@repo/database';\r\nimport { IOrderRepository, OrderSearchFilters, OrderSearchResult } from '../../domain/repositories/IOrderRepository';\r\nimport { Order, OrderStatus } from '../../domain/aggregates/Order';\r\nimport { OrderItem } from '../../domain/entities/OrderItem';\r\nimport { OrderNumber } from '../../domain/value-objects/OrderNumber';\r\nimport { ShippingAddress } from '../../domain/value-objects/ShippingAddress';\r\nimport { Money } from '../../../marketplace/domain/value-objects/Money';\r\n\r\nexport class PrismaOrderRepository implements IOrderRepository {\r\n  constructor(private prisma: PrismaClient) {}\r\n\r\n  async findById(id: string): Promise<Order | null> {\r\n    const data = await this.prisma.order.findUnique({\r\n      where: { id },\r\n      include: {\r\n        items: true,\r\n      },\r\n    });\r\n\r\n    if (!data) return null;\r\n\r\n    return this.toDomain(data);\r\n  }\r\n\r\n  async findByOrderNumber(orderNumber: string): Promise<Order | null> {\r\n    const data = await this.prisma.order.findUnique({\r\n      where: { orderNumber },\r\n      include: {\r\n        items: true,\r\n      },\r\n    });\r\n\r\n    if (!data) return null;\r\n\r\n    return this.toDomain(data);\r\n  }\r\n\r\n  async findByBuyerId(buyerId: string): Promise<Order[]> {\r\n    const data = await this.prisma.order.findMany({\r\n      where: { buyerId },\r\n      include: {\r\n        items: true,\r\n      },\r\n      orderBy: { createdAt: 'desc' },\r\n    });\r\n\r\n    return data.map((d: any) => this.toDomain(d));\r\n  }\r\n\r\n  async findBySellerId(sellerId: string): Promise<Order[]> {\r\n    const data = await this.prisma.order.findMany({\r\n      where: { sellerId },\r\n      include: {\r\n        items: true,\r\n      },\r\n      orderBy: { createdAt: 'desc' },\r\n    });\r\n\r\n    return data.map((d: any) => this.toDomain(d));\r\n  }\r\n\r\n  async search(filters: OrderSearchFilters): Promise<OrderSearchResult> {\r\n    const where: any = {};\r\n\r\n    if (filters.buyerId) {\r\n      where.buyerId = filters.buyerId;\r\n    }\r\n\r\n    if (filters.sellerId) {\r\n      where.sellerId = filters.sellerId;\r\n    }\r\n\r\n    if (filters.status) {\r\n      where.status = filters.status;\r\n    }\r\n\r\n    if (filters.fromDate || filters.toDate) {\r\n      where.createdAt = {};\r\n      if (filters.fromDate) {\r\n        where.createdAt.gte = filters.fromDate;\r\n      }\r\n      if (filters.toDate) {\r\n        where.createdAt.lte = filters.toDate;\r\n      }\r\n    }\r\n\r\n    const limit = filters.limit ?? 20;\r\n    const offset = filters.offset ?? 0;\r\n\r\n    const [data, total] = await Promise.all([\r\n      this.prisma.order.findMany({\r\n        where,\r\n        include: {\r\n          items: true,\r\n        },\r\n        take: limit,\r\n        skip: offset,\r\n        orderBy: { createdAt: 'desc' },\r\n      }),\r\n      this.prisma.order.count({ where }),\r\n    ]);\r\n\r\n    return {\r\n      orders: data.map((d: any) => this.toDomain(d)),\r\n      total,\r\n      limit,\r\n      offset,\r\n    };\r\n  }\r\n\r\n  async save(order: Order): Promise<void> {\r\n    const data = this.toPersistence(order);\r\n\r\n    await this.prisma.order.upsert({\r\n      where: { id: order.id },\r\n      create: {\r\n        ...data,\r\n        items: {\r\n          create: data.items,\r\n        },\r\n      },\r\n      update: {\r\n        status: data.status,\r\n        paymentIntentId: data.paymentIntentId,\r\n        trackingNumber: data.trackingNumber,\r\n        notes: data.notes,\r\n        paidAt: data.paidAt,\r\n        shippedAt: data.shippedAt,\r\n        deliveredAt: data.deliveredAt,\r\n        cancelledAt: data.cancelledAt,\r\n        updatedAt: data.updatedAt,\r\n      },\r\n    });\r\n\r\n    // Clear domain events\r\n    order.clearDomainEvents();\r\n  }\r\n\r\n  async count(filters?: Partial<OrderSearchFilters>): Promise<number> {\r\n    const where: any = {};\r\n\r\n    if (filters?.buyerId) {\r\n      where.buyerId = filters.buyerId;\r\n    }\r\n\r\n    if (filters?.sellerId) {\r\n      where.sellerId = filters.sellerId;\r\n    }\r\n\r\n    if (filters?.status) {\r\n      where.status = filters.status;\r\n    }\r\n\r\n    return this.prisma.order.count({ where });\r\n  }\r\n\r\n  async findByStatus(status: OrderStatus): Promise<Order[]> {\r\n    const data = await this.prisma.order.findMany({\r\n      where: { status },\r\n      include: {\r\n        items: true,\r\n      },\r\n      orderBy: { createdAt: 'desc' },\r\n    });\r\n\r\n    return data.map((d: any) => this.toDomain(d));\r\n  }\r\n\r\n  /**\r\n   * Convert Prisma model to Domain aggregate\r\n   */\r\n  private toDomain(data: any): Order {\r\n    // Parse items\r\n    const items = data.items.map((item: any) =>\r\n      OrderItem.reconstitute({\r\n        id: item.id,\r\n        listingId: item.listingId,\r\n        quantity: item.quantity,\r\n        unitPrice: Money.create(Number(item.unitPrice), 'USD'),\r\n        totalPrice: Money.create(Number(item.totalPrice), 'USD'),\r\n        sellerName: item.sellerName,\r\n      })\r\n    );\r\n\r\n    // Parse shipping address\r\n    const shippingAddress = ShippingAddress.create(\r\n      typeof data.shippingAddress === 'string'\r\n        ? JSON.parse(data.shippingAddress)\r\n        : data.shippingAddress\r\n    );\r\n\r\n    return Order.reconstitute({\r\n      id: data.id,\r\n      orderNumber: OrderNumber.fromString(data.orderNumber),\r\n      buyerId: data.buyerId,\r\n      sellerId: data.sellerId,\r\n      items,\r\n      totalAmount: Money.create(Number(data.totalAmount), 'USD'),\r\n      shippingAddress,\r\n      status: data.status as OrderStatus,\r\n      paymentIntentId: data.paymentIntentId ?? undefined,\r\n      trackingNumber: data.trackingNumber ?? undefined,\r\n      notes: data.notes ?? undefined,\r\n      createdAt: data.createdAt,\r\n      updatedAt: data.updatedAt,\r\n      paidAt: data.paidAt ?? undefined,\r\n      shippedAt: data.shippedAt ?? undefined,\r\n      deliveredAt: data.deliveredAt ?? undefined,\r\n      cancelledAt: data.cancelledAt ?? undefined,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Convert Domain aggregate to Prisma model data\r\n   */\r\n  private toPersistence(order: Order): any {\r\n    const props = order.getProps();\r\n\r\n    return {\r\n      id: order.id,\r\n      orderNumber: order.orderNumber.getValue(),\r\n      buyerId: order.buyerId,\r\n      sellerId: order.sellerId,\r\n      totalAmount: order.totalAmount.getAmount(),\r\n      shippingAddress: order.shippingAddress.toObject(),\r\n      status: order.status,\r\n      paymentIntentId: order.paymentIntentId ?? null,\r\n      trackingNumber: order.trackingNumber ?? null,\r\n      notes: order.notes ?? null,\r\n      createdAt: order.createdAt,\r\n      updatedAt: order.updatedAt,\r\n      paidAt: order.paidAt ?? null,\r\n      shippedAt: order.shippedAt ?? null,\r\n      deliveredAt: order.deliveredAt ?? null,\r\n      cancelledAt: props.cancelledAt ?? null,\r\n      items: order.items.map((item) => ({\r\n        id: item.id,\r\n        listingId: item.listingId,\r\n        quantity: item.quantity,\r\n        unitPrice: item.unitPrice.getAmount(),\r\n        totalPrice: item.totalPrice.getAmount(),\r\n        sellerName: item.sellerName ?? null,\r\n      })),\r\n    };\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 831, "column": 0}, "map": {"version":3,"sources":["file:///J:/projects/tree/packages/core/src/marketplace/domain/aggregates/Listing.ts"],"sourcesContent":["/**\r\n * Listing Aggregate Root\r\n * \r\n * Central aggregate for marketplace listings.\r\n * Manages product listings, inventory, pricing, and publication status.\r\n * Emits domain events for state changes.\r\n */\r\n\r\nimport { Money } from '../value-objects/Money';\r\n\r\nexport enum ListingStatus {\r\n  DRAFT = 'DRAFT',\r\n  ACTIVE = 'ACTIVE',\r\n  SOLD_OUT = 'SOLD_OUT',\r\n  FLAGGED = 'FLAGGED',\r\n  ARCHIVED = 'ARCHIVED',\r\n}\r\n\r\nexport interface DomainEvent {\r\n  type: string;\r\n  aggregateId: string;\r\n  occurredAt: Date;\r\n  data: any;\r\n}\r\n\r\nexport interface ListingProps {\r\n  id: string;\r\n  sellerId: string;\r\n  speciesId: string;\r\n  title: string;\r\n  description: string;\r\n  basePrice: Money;\r\n  inventory: number;\r\n  status: ListingStatus;\r\n  viewCount: number;\r\n  metadata?: object;\r\n  createdAt: Date;\r\n  updatedAt: Date;\r\n  publishedAt?: Date;\r\n}\r\n\r\nexport class Listing {\r\n  private props: ListingProps;\r\n  private domainEvents: DomainEvent[] = [];\r\n\r\n  private constructor(props: ListingProps) {\r\n    this.props = props;\r\n  }\r\n\r\n  /**\r\n   * Create a new listing (starts in DRAFT status)\r\n   */\r\n  public static create(\r\n    props: Omit<ListingProps, 'id' | 'status' | 'viewCount' | 'createdAt' | 'updatedAt'>\r\n  ): Listing {\r\n    // Validate title\r\n    if (!props.title || props.title.trim().length === 0) {\r\n      throw new Error('Title cannot be empty');\r\n    }\r\n    if (props.title.length < 10) {\r\n      throw new Error('Title must be at least 10 characters');\r\n    }\r\n    if (props.title.length > 200) {\r\n      throw new Error('Title cannot exceed 200 characters');\r\n    }\r\n\r\n    // Validate description\r\n    if (!props.description || props.description.trim().length === 0) {\r\n      throw new Error('Description cannot be empty');\r\n    }\r\n    if (props.description.length < 50) {\r\n      throw new Error('Description must be at least 50 characters');\r\n    }\r\n\r\n    // Validate price\r\n    if (props.basePrice.isZero() || props.basePrice.getAmount() <= 0) {\r\n      throw new Error('Base price must be greater than zero');\r\n    }\r\n\r\n    // Validate inventory\r\n    if (props.inventory < 0) {\r\n      throw new Error('Inventory cannot be negative');\r\n    }\r\n\r\n    const listing = new Listing({\r\n      ...props,\r\n      id: crypto.randomUUID(),\r\n      status: ListingStatus.DRAFT,\r\n      viewCount: 0,\r\n      createdAt: new Date(),\r\n      updatedAt: new Date(),\r\n    });\r\n\r\n    listing.addDomainEvent({\r\n      type: 'ListingCreated',\r\n      aggregateId: listing.id,\r\n      occurredAt: new Date(),\r\n      data: {\r\n        listingId: listing.id,\r\n        sellerId: listing.sellerId,\r\n        title: listing.title,\r\n      },\r\n    });\r\n\r\n    return listing;\r\n  }\r\n\r\n  /**\r\n   * Reconstitute a listing from persistence\r\n   */\r\n  public static reconstitute(props: ListingProps): Listing {\r\n    return new Listing(props);\r\n  }\r\n\r\n  /**\r\n   * Publish the listing (make it visible to buyers)\r\n   */\r\n  public publish(): void {\r\n    if (this.props.inventory === 0) {\r\n      throw new Error('Cannot publish listing with zero inventory');\r\n    }\r\n\r\n    if (this.props.status !== ListingStatus.DRAFT) {\r\n      throw new Error('Only draft listings can be published');\r\n    }\r\n\r\n    this.props.status = ListingStatus.ACTIVE;\r\n    this.props.publishedAt = new Date();\r\n    this.props.updatedAt = new Date();\r\n\r\n    this.addDomainEvent({\r\n      type: 'ListingPublished',\r\n      aggregateId: this.props.id,\r\n      occurredAt: new Date(),\r\n      data: {\r\n        listingId: this.props.id,\r\n        publishedAt: this.props.publishedAt,\r\n      },\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Update listing details\r\n   */\r\n  public updateDetails(title: string, description: string): void {\r\n    if (this.props.status === ListingStatus.ARCHIVED) {\r\n      throw new Error('Cannot update archived listing');\r\n    }\r\n\r\n    if (title && title.length >= 10 && title.length <= 200) {\r\n      this.props.title = title;\r\n    }\r\n\r\n    if (description && description.length >= 50) {\r\n      this.props.description = description;\r\n    }\r\n\r\n    this.props.updatedAt = new Date();\r\n  }\r\n\r\n  /**\r\n   * Update the base price\r\n   */\r\n  public updatePrice(newPrice: Money): void {\r\n    if (this.props.status === ListingStatus.ARCHIVED) {\r\n      throw new Error('Cannot update price of archived listing');\r\n    }\r\n\r\n    if (newPrice.isZero() || newPrice.getAmount() <= 0) {\r\n      throw new Error('Price must be greater than zero');\r\n    }\r\n\r\n    this.props.basePrice = newPrice;\r\n    this.props.updatedAt = new Date();\r\n\r\n    this.addDomainEvent({\r\n      type: 'ListingPriceUpdated',\r\n      aggregateId: this.props.id,\r\n      occurredAt: new Date(),\r\n      data: {\r\n        listingId: this.props.id,\r\n        newPrice: newPrice.getAmount(),\r\n        currency: newPrice.getCurrency(),\r\n      },\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Set inventory to a specific amount\r\n   */\r\n  public updateInventory(quantity: number): void {\r\n    if (quantity < 0) {\r\n      throw new Error('Inventory cannot be negative');\r\n    }\r\n\r\n    const previousInventory = this.props.inventory;\r\n    this.props.inventory = quantity;\r\n    this.props.updatedAt = new Date();\r\n\r\n    // If inventory drops to zero, mark as sold out\r\n    if (quantity === 0 && this.props.status === ListingStatus.ACTIVE) {\r\n      this.markAsSoldOut();\r\n    }\r\n\r\n    // If inventory was zero and now has stock, reactivate\r\n    if (previousInventory === 0 && quantity > 0 && this.props.status === ListingStatus.SOLD_OUT) {\r\n      this.props.status = ListingStatus.ACTIVE;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Decrease inventory by a specific amount (e.g., after purchase)\r\n   */\r\n  public decreaseInventory(amount: number): void {\r\n    if (amount <= 0) {\r\n      throw new Error('Amount to decrease must be positive');\r\n    }\r\n\r\n    const newInventory = this.props.inventory - amount;\r\n    if (newInventory < 0) {\r\n      throw new Error('Insufficient inventory');\r\n    }\r\n\r\n    this.updateInventory(newInventory);\r\n  }\r\n\r\n  /**\r\n   * Increase inventory by a specific amount (e.g., restock)\r\n   */\r\n  public increaseInventory(amount: number): void {\r\n    if (amount <= 0) {\r\n      throw new Error('Amount to increase must be positive');\r\n    }\r\n\r\n    this.updateInventory(this.props.inventory + amount);\r\n  }\r\n\r\n  /**\r\n   * Increment view count (for analytics)\r\n   */\r\n  public incrementViewCount(): void {\r\n    this.props.viewCount += 1;\r\n  }\r\n\r\n  /**\r\n   * Flag the listing (e.g., for fraud, policy violation)\r\n   */\r\n  public flag(reason: string): void {\r\n    if (!reason || reason.trim().length === 0) {\r\n      throw new Error('Flag reason is required');\r\n    }\r\n\r\n    this.props.status = ListingStatus.FLAGGED;\r\n    this.props.updatedAt = new Date();\r\n\r\n    this.addDomainEvent({\r\n      type: 'ListingFlagged',\r\n      aggregateId: this.props.id,\r\n      occurredAt: new Date(),\r\n      data: {\r\n        listingId: this.props.id,\r\n        reason,\r\n      },\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Unflag the listing (after review)\r\n   */\r\n  public unflag(): void {\r\n    if (this.props.status !== ListingStatus.FLAGGED) {\r\n      throw new Error('Listing is not flagged');\r\n    }\r\n\r\n    // Return to previous status based on inventory\r\n    this.props.status = this.props.inventory > 0 ? ListingStatus.ACTIVE : ListingStatus.DRAFT;\r\n    this.props.updatedAt = new Date();\r\n  }\r\n\r\n  /**\r\n   * Archive the listing (soft delete)\r\n   */\r\n  public archive(): void {\r\n    this.props.status = ListingStatus.ARCHIVED;\r\n    this.props.updatedAt = new Date();\r\n\r\n    this.addDomainEvent({\r\n      type: 'ListingArchived',\r\n      aggregateId: this.props.id,\r\n      occurredAt: new Date(),\r\n      data: {\r\n        listingId: this.props.id,\r\n      },\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Mark listing as sold out\r\n   */\r\n  private markAsSoldOut(): void {\r\n    this.props.status = ListingStatus.SOLD_OUT;\r\n\r\n    this.addDomainEvent({\r\n      type: 'ListingSoldOut',\r\n      aggregateId: this.props.id,\r\n      occurredAt: new Date(),\r\n      data: {\r\n        listingId: this.props.id,\r\n      },\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Check if listing is available for purchase\r\n   */\r\n  public isAvailable(): boolean {\r\n    return this.props.status === ListingStatus.ACTIVE && this.props.inventory > 0;\r\n  }\r\n\r\n  /**\r\n   * Check if listing is visible to buyers\r\n   */\r\n  public isVisible(): boolean {\r\n    return this.props.status === ListingStatus.ACTIVE || this.props.status === ListingStatus.SOLD_OUT;\r\n  }\r\n\r\n  /**\r\n   * Update metadata (SEO, tags, etc.)\r\n   */\r\n  public updateMetadata(metadata: object): void {\r\n    this.props.metadata = metadata;\r\n    this.props.updatedAt = new Date();\r\n  }\r\n\r\n  // Domain Events Management\r\n  private addDomainEvent(event: DomainEvent): void {\r\n    this.domainEvents.push(event);\r\n  }\r\n\r\n  public getDomainEvents(): readonly DomainEvent[] {\r\n    return [...this.domainEvents];\r\n  }\r\n\r\n  public clearDomainEvents(): void {\r\n    this.domainEvents = [];\r\n  }\r\n\r\n  // Getters\r\n  get id(): string {\r\n    return this.props.id;\r\n  }\r\n\r\n  get sellerId(): string {\r\n    return this.props.sellerId;\r\n  }\r\n\r\n  get speciesId(): string {\r\n    return this.props.speciesId;\r\n  }\r\n\r\n  get title(): string {\r\n    return this.props.title;\r\n  }\r\n\r\n  get description(): string {\r\n    return this.props.description;\r\n  }\r\n\r\n  get basePrice(): Money {\r\n    return this.props.basePrice;\r\n  }\r\n\r\n  get inventory(): number {\r\n    return this.props.inventory;\r\n  }\r\n\r\n  get status(): ListingStatus {\r\n    return this.props.status;\r\n  }\r\n\r\n  get viewCount(): number {\r\n    return this.props.viewCount;\r\n  }\r\n\r\n  get metadata(): object | undefined {\r\n    return this.props.metadata;\r\n  }\r\n\r\n  get createdAt(): Date {\r\n    return this.props.createdAt;\r\n  }\r\n\r\n  get updatedAt(): Date {\r\n    return this.props.updatedAt;\r\n  }\r\n\r\n  get publishedAt(): Date | undefined {\r\n    return this.props.publishedAt;\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1139, "column": 0}, "map": {"version":3,"sources":["file:///J:/projects/tree/packages/core/src/marketplace/infrastructure/repositories/PrismaListingRepository.ts"],"sourcesContent":["/**\r\n * Prisma Listing Repository Implementation\r\n * \r\n * Implements IListingRepository using Prisma ORM.\r\n * Handles mapping between domain entities and database models.\r\n */\r\n\r\nimport { PrismaClient } from '@repo/database';\r\nimport { IListingRepository, ListingSearchFilters, ListingSearchResult } from '../../domain/repositories/IListingRepository';\r\nimport { Listing, ListingStatus } from '../../domain/aggregates/Listing';\r\nimport { Money } from '../../domain/value-objects/Money';\r\n\r\nexport class PrismaListingRepository implements IListingRepository {\r\n  constructor(private prisma: PrismaClient) {}\r\n\r\n  async findById(id: string): Promise<Listing | null> {\r\n    const data = await this.prisma.listing.findUnique({\r\n      where: { id, deletedAt: null },\r\n    });\r\n\r\n    if (!data) return null;\r\n\r\n    return this.toDomain(data);\r\n  }\r\n\r\n  async findByIds(ids: string[]): Promise<Listing[]> {\r\n    const data = await this.prisma.listing.findMany({\r\n      where: { \r\n        id: { in: ids },\r\n        deletedAt: null,\r\n      },\r\n    });\r\n\r\n    return data.map((d: any) => this.toDomain(d));\r\n  }\r\n\r\n  async findBySellerId(sellerId: string): Promise<Listing[]> {\r\n    const data = await this.prisma.listing.findMany({\r\n      where: { \r\n        sellerId,\r\n        deletedAt: null,\r\n      },\r\n      orderBy: { createdAt: 'desc' },\r\n    });\r\n\r\n    return data.map((d: any) => this.toDomain(d));\r\n  }\r\n\r\n  async findBySpeciesId(speciesId: string): Promise<Listing[]> {\r\n    const data = await this.prisma.listing.findMany({\r\n      where: { \r\n        speciesId,\r\n        deletedAt: null,\r\n      },\r\n      orderBy: { createdAt: 'desc' },\r\n    });\r\n\r\n    return data.map((d: any) => this.toDomain(d));\r\n  }\r\n\r\n  async search(filters: ListingSearchFilters): Promise<ListingSearchResult> {\r\n    const where: any = { deletedAt: null };\r\n\r\n    if (filters.speciesId) {\r\n      where.speciesId = filters.speciesId;\r\n    }\r\n\r\n    if (filters.sellerId) {\r\n      where.sellerId = filters.sellerId;\r\n    }\r\n\r\n    if (filters.status) {\r\n      where.status = filters.status;\r\n    }\r\n\r\n    if (filters.minPrice !== undefined || filters.maxPrice !== undefined) {\r\n      where.basePrice = {};\r\n      if (filters.minPrice !== undefined) {\r\n        where.basePrice.gte = filters.minPrice;\r\n      }\r\n      if (filters.maxPrice !== undefined) {\r\n        where.basePrice.lte = filters.maxPrice;\r\n      }\r\n    }\r\n\r\n    if (filters.searchTerm) {\r\n      where.OR = [\r\n        { title: { contains: filters.searchTerm, mode: 'insensitive' } },\r\n        { description: { contains: filters.searchTerm, mode: 'insensitive' } },\r\n      ];\r\n    }\r\n\r\n    const limit = filters.limit ?? 20;\r\n    const offset = filters.offset ?? 0;\r\n\r\n    const [data, total] = await Promise.all([\r\n      this.prisma.listing.findMany({\r\n        where,\r\n        take: limit,\r\n        skip: offset,\r\n        orderBy: { \r\n          publishedAt: { sort: 'desc', nulls: 'last' },\r\n        },\r\n      }),\r\n      this.prisma.listing.count({ where }),\r\n    ]);\r\n\r\n    return {\r\n      listings: data.map((d: any) => this.toDomain(d)),\r\n      total,\r\n      limit,\r\n      offset,\r\n    };\r\n  }\r\n\r\n  async save(listing: Listing): Promise<void> {\r\n    const data = this.toPersistence(listing);\r\n\r\n    await this.prisma.listing.upsert({\r\n      where: { id: listing.id },\r\n      create: data,\r\n      update: {\r\n        title: data.title,\r\n        description: data.description,\r\n        basePrice: data.basePrice,\r\n        inventory: data.inventory,\r\n        status: data.status,\r\n        viewCount: data.viewCount,\r\n        metadata: data.metadata,\r\n        publishedAt: data.publishedAt,\r\n        updatedAt: data.updatedAt,\r\n      },\r\n    });\r\n\r\n    // In a real implementation, you would also persist domain events here\r\n    // For now, we'll just clear them\r\n    listing.clearDomainEvents();\r\n  }\r\n\r\n  async delete(id: string): Promise<void> {\r\n    await this.prisma.listing.update({\r\n      where: { id },\r\n      data: { deletedAt: new Date() },\r\n    });\r\n  }\r\n\r\n  async count(status?: string): Promise<number> {\r\n    const where: any = { deletedAt: null };\r\n    \r\n    if (status) {\r\n      where.status = status;\r\n    }\r\n\r\n    return this.prisma.listing.count({ where });\r\n  }\r\n\r\n  async findNeedingAttention(): Promise<Listing[]> {\r\n    const data = await this.prisma.listing.findMany({\r\n      where: {\r\n        deletedAt: null,\r\n        OR: [\r\n          { status: 'FLAGGED' },\r\n          { status: 'SOLD_OUT' },\r\n          {\r\n            status: 'ACTIVE',\r\n            inventory: { lte: 5 }, // Low inventory warning\r\n          },\r\n        ],\r\n      },\r\n      orderBy: { updatedAt: 'desc' },\r\n    });\r\n\r\n    return data.map((d: any) => this.toDomain(d));\r\n  }\r\n\r\n  /**\r\n   * Convert Prisma model to Domain entity\r\n   */\r\n  private toDomain(data: any): Listing {\r\n    return Listing.reconstitute({\r\n      id: data.id,\r\n      sellerId: data.sellerId,\r\n      speciesId: data.speciesId,\r\n      title: data.title,\r\n      description: data.description,\r\n      basePrice: Money.create(Number(data.basePrice), 'USD'),\r\n      inventory: data.inventory,\r\n      status: data.status as ListingStatus,\r\n      viewCount: data.viewCount,\r\n      metadata: data.metadata as object | undefined,\r\n      createdAt: data.createdAt,\r\n      updatedAt: data.updatedAt,\r\n      publishedAt: data.publishedAt ?? undefined,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Convert Domain entity to Prisma model data\r\n   */\r\n  private toPersistence(listing: Listing): any {\r\n    return {\r\n      id: listing.id,\r\n      sellerId: listing.sellerId,\r\n      speciesId: listing.speciesId,\r\n      title: listing.title,\r\n      description: listing.description,\r\n      basePrice: listing.basePrice.getAmount(),\r\n      inventory: listing.inventory,\r\n      status: listing.status,\r\n      viewCount: listing.viewCount,\r\n      metadata: listing.metadata ?? null,\r\n      publishedAt: listing.publishedAt ?? null,\r\n      createdAt: listing.createdAt,\r\n      updatedAt: listing.updatedAt,\r\n    };\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1401, "column": 0}, "map": {"version":3,"sources":["file:///J:/projects/tree/packages/core/src/identity/domain/value-objects/AccessToken.ts"],"sourcesContent":["/**\r\n * AccessToken Value Object\r\n * \r\n * Encapsulates JWT access token logic.\r\n * Short-lived token for API authentication (15 minutes).\r\n */\r\n\r\nimport jwt from 'jsonwebtoken';\r\n\r\nexport interface AccessTokenPayload {\r\n  userId: string;\r\n  email: string;\r\n  role: string;\r\n}\r\n\r\nexport class AccessToken {\r\n  private readonly token: string;\r\n  private static readonly EXPIRY = '15m'; // 15 minutes\r\n  private static readonly SECRET = process.env.JWT_ACCESS_SECRET || 'default-access-secret-change-in-production';\r\n\r\n  private constructor(token: string) {\r\n    this.token = token;\r\n  }\r\n\r\n  /**\r\n   * Generate a new access token\r\n   */\r\n  public static generate(payload: AccessTokenPayload): AccessToken {\r\n    const token = jwt.sign(\r\n      payload,\r\n      AccessToken.SECRET,\r\n      {\r\n        expiresIn: AccessToken.EXPIRY,\r\n        issuer: 'treeverse-api',\r\n        audience: 'treeverse-client',\r\n      }\r\n    );\r\n\r\n    return new AccessToken(token);\r\n  }\r\n\r\n  /**\r\n   * Verify and decode an access token\r\n   */\r\n  public static verify(token: string): AccessTokenPayload {\r\n    try {\r\n      const decoded = jwt.verify(token, AccessToken.SECRET, {\r\n        issuer: 'treeverse-api',\r\n        audience: 'treeverse-client',\r\n      }) as AccessTokenPayload;\r\n\r\n      return decoded;\r\n    } catch (error) {\r\n      if (error instanceof jwt.TokenExpiredError) {\r\n        throw new Error('Access token has expired');\r\n      }\r\n      if (error instanceof jwt.JsonWebTokenError) {\r\n        throw new Error('Invalid access token');\r\n      }\r\n      throw new Error('Access token verification failed');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Create from existing token string (for verification)\r\n   */\r\n  public static fromString(token: string): AccessToken {\r\n    // Verify the token is valid before creating the value object\r\n    AccessToken.verify(token);\r\n    return new AccessToken(token);\r\n  }\r\n\r\n  /**\r\n   * Get the token string\r\n   */\r\n  public getValue(): string {\r\n    return this.token;\r\n  }\r\n\r\n  /**\r\n   * Check if token is expired\r\n   */\r\n  public isExpired(): boolean {\r\n    try {\r\n      jwt.verify(this.token, AccessToken.SECRET);\r\n      return false;\r\n    } catch (error) {\r\n      if (error instanceof jwt.TokenExpiredError) {\r\n        return true;\r\n      }\r\n      return false;\r\n    }\r\n  }\r\n}\r\n"],"names":[],"mappings":"AAAA;;;;;CAKC;;;;AAED;;AAQO,MAAM;IACM,MAAc;IAC/B,OAAwB,SAAS,MAAM;IACvC,OAAwB,SAAS,QAAQ,GAAG,CAAC,iBAAiB,IAAI,6CAA6C;IAE/G,YAAoB,KAAa,CAAE;QACjC,IAAI,CAAC,KAAK,GAAG;IACf;IAEA;;GAEC,GACD,OAAc,SAAS,OAA2B,EAAe;QAC/D,MAAM,QAAQ,2MAAG,CAAC,IAAI,CACpB,SACA,YAAY,MAAM,EAClB;YACE,WAAW,YAAY,MAAM;YAC7B,QAAQ;YACR,UAAU;QACZ;QAGF,OAAO,IAAI,YAAY;IACzB;IAEA;;GAEC,GACD,OAAc,OAAO,KAAa,EAAsB;QACtD,IAAI;YACF,MAAM,UAAU,2MAAG,CAAC,MAAM,CAAC,OAAO,YAAY,MAAM,EAAE;gBACpD,QAAQ;gBACR,UAAU;YACZ;YAEA,OAAO;QACT,EAAE,OAAO,OAAO;YACd,IAAI,iBAAiB,2MAAG,CAAC,iBAAiB,EAAE;gBAC1C,MAAM,IAAI,MAAM;YAClB;YACA,IAAI,iBAAiB,2MAAG,CAAC,iBAAiB,EAAE;gBAC1C,MAAM,IAAI,MAAM;YAClB;YACA,MAAM,IAAI,MAAM;QAClB;IACF;IAEA;;GAEC,GACD,OAAc,WAAW,KAAa,EAAe;QACnD,6DAA6D;QAC7D,YAAY,MAAM,CAAC;QACnB,OAAO,IAAI,YAAY;IACzB;IAEA;;GAEC,GACD,AAAO,WAAmB;QACxB,OAAO,IAAI,CAAC,KAAK;IACnB;IAEA;;GAEC,GACD,AAAO,YAAqB;QAC1B,IAAI;YACF,2MAAG,CAAC,MAAM,CAAC,IAAI,CAAC,KAAK,EAAE,YAAY,MAAM;YACzC,OAAO;QACT,EAAE,OAAO,OAAO;YACd,IAAI,iBAAiB,2MAAG,CAAC,iBAAiB,EAAE;gBAC1C,OAAO;YACT;YACA,OAAO;QACT;IACF;AACF"}},
    {"offset": {"line": 1478, "column": 0}, "map": {"version":3,"sources":["file:///J:/projects/tree/packages/core/src/identity/domain/value-objects/RefreshToken.ts"],"sourcesContent":["/**\r\n * RefreshToken Value Object\r\n * \r\n * Encapsulates JWT refresh token logic.\r\n * Long-lived token for obtaining new access tokens (7 days).\r\n */\r\n\r\nimport jwt from 'jsonwebtoken';\r\nimport { randomBytes } from 'crypto';\r\n\r\nexport interface RefreshTokenPayload {\r\n  userId: string;\r\n  tokenId: string; // Unique ID for token rotation/revocation\r\n}\r\n\r\nexport class RefreshToken {\r\n  private readonly token: string;\r\n  private static readonly EXPIRY = '7d'; // 7 days\r\n  private static readonly SECRET = process.env.JWT_REFRESH_SECRET || 'default-refresh-secret-change-in-production';\r\n\r\n  private constructor(token: string) {\r\n    this.token = token;\r\n  }\r\n\r\n  /**\r\n   * Generate a new refresh token\r\n   */\r\n  public static generate(userId: string): RefreshToken {\r\n    const tokenId = RefreshToken.generateTokenId();\r\n\r\n    const token = jwt.sign(\r\n      { userId, tokenId } as RefreshTokenPayload,\r\n      RefreshToken.SECRET,\r\n      {\r\n        expiresIn: RefreshToken.EXPIRY,\r\n        issuer: 'treeverse-api',\r\n        audience: 'treeverse-client',\r\n      }\r\n    );\r\n\r\n    return new RefreshToken(token);\r\n  }\r\n\r\n  /**\r\n   * Verify and decode a refresh token\r\n   */\r\n  public static verify(token: string): RefreshTokenPayload {\r\n    try {\r\n      const decoded = jwt.verify(token, RefreshToken.SECRET, {\r\n        issuer: 'treeverse-api',\r\n        audience: 'treeverse-client',\r\n      }) as RefreshTokenPayload;\r\n\r\n      return decoded;\r\n    } catch (error) {\r\n      if (error instanceof jwt.TokenExpiredError) {\r\n        throw new Error('Refresh token has expired');\r\n      }\r\n      if (error instanceof jwt.JsonWebTokenError) {\r\n        throw new Error('Invalid refresh token');\r\n      }\r\n      throw new Error('Refresh token verification failed');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Create from existing token string (for verification)\r\n   */\r\n  public static fromString(token: string): RefreshToken {\r\n    // Verify the token is valid before creating the value object\r\n    RefreshToken.verify(token);\r\n    return new RefreshToken(token);\r\n  }\r\n\r\n  /**\r\n   * Generate a unique token ID for tracking/revocation\r\n   */\r\n  private static generateTokenId(): string {\r\n    return randomBytes(16).toString('hex');\r\n  }\r\n\r\n  /**\r\n   * Get the token string\r\n   */\r\n  public getValue(): string {\r\n    return this.token;\r\n  }\r\n\r\n  /**\r\n   * Get the token ID from the token\r\n   */\r\n  public getTokenId(): string {\r\n    const payload = RefreshToken.verify(this.token);\r\n    return payload.tokenId;\r\n  }\r\n\r\n  /**\r\n   * Get the user ID from the token\r\n   */\r\n  public getUserId(): string {\r\n    const payload = RefreshToken.verify(this.token);\r\n    return payload.userId;\r\n  }\r\n\r\n  /**\r\n   * Check if token is expired\r\n   */\r\n  public isExpired(): boolean {\r\n    try {\r\n      jwt.verify(this.token, RefreshToken.SECRET);\r\n      return false;\r\n    } catch (error) {\r\n      if (error instanceof jwt.TokenExpiredError) {\r\n        return true;\r\n      }\r\n      return false;\r\n    }\r\n  }\r\n}\r\n"],"names":[],"mappings":"AAAA;;;;;CAKC;;;;AAED;AACA;;;AAOO,MAAM;IACM,MAAc;IAC/B,OAAwB,SAAS,KAAK;IACtC,OAAwB,SAAS,QAAQ,GAAG,CAAC,kBAAkB,IAAI,8CAA8C;IAEjH,YAAoB,KAAa,CAAE;QACjC,IAAI,CAAC,KAAK,GAAG;IACf;IAEA;;GAEC,GACD,OAAc,SAAS,MAAc,EAAgB;QACnD,MAAM,UAAU,aAAa,eAAe;QAE5C,MAAM,QAAQ,2MAAG,CAAC,IAAI,CACpB;YAAE;YAAQ;QAAQ,GAClB,aAAa,MAAM,EACnB;YACE,WAAW,aAAa,MAAM;YAC9B,QAAQ;YACR,UAAU;QACZ;QAGF,OAAO,IAAI,aAAa;IAC1B;IAEA;;GAEC,GACD,OAAc,OAAO,KAAa,EAAuB;QACvD,IAAI;YACF,MAAM,UAAU,2MAAG,CAAC,MAAM,CAAC,OAAO,aAAa,MAAM,EAAE;gBACrD,QAAQ;gBACR,UAAU;YACZ;YAEA,OAAO;QACT,EAAE,OAAO,OAAO;YACd,IAAI,iBAAiB,2MAAG,CAAC,iBAAiB,EAAE;gBAC1C,MAAM,IAAI,MAAM;YAClB;YACA,IAAI,iBAAiB,2MAAG,CAAC,iBAAiB,EAAE;gBAC1C,MAAM,IAAI,MAAM;YAClB;YACA,MAAM,IAAI,MAAM;QAClB;IACF;IAEA;;GAEC,GACD,OAAc,WAAW,KAAa,EAAgB;QACpD,6DAA6D;QAC7D,aAAa,MAAM,CAAC;QACpB,OAAO,IAAI,aAAa;IAC1B;IAEA;;GAEC,GACD,OAAe,kBAA0B;QACvC,OAAO,IAAA,oHAAW,EAAC,IAAI,QAAQ,CAAC;IAClC;IAEA;;GAEC,GACD,AAAO,WAAmB;QACxB,OAAO,IAAI,CAAC,KAAK;IACnB;IAEA;;GAEC,GACD,AAAO,aAAqB;QAC1B,MAAM,UAAU,aAAa,MAAM,CAAC,IAAI,CAAC,KAAK;QAC9C,OAAO,QAAQ,OAAO;IACxB;IAEA;;GAEC,GACD,AAAO,YAAoB;QACzB,MAAM,UAAU,aAAa,MAAM,CAAC,IAAI,CAAC,KAAK;QAC9C,OAAO,QAAQ,MAAM;IACvB;IAEA;;GAEC,GACD,AAAO,YAAqB;QAC1B,IAAI;YACF,2MAAG,CAAC,MAAM,CAAC,IAAI,CAAC,KAAK,EAAE,aAAa,MAAM;YAC1C,OAAO;QACT,EAAE,OAAO,OAAO;YACd,IAAI,iBAAiB,2MAAG,CAAC,iBAAiB,EAAE;gBAC1C,OAAO;YACT;YACA,OAAO;QACT;IACF;AACF"}},
    {"offset": {"line": 1578, "column": 0}, "map": {"version":3,"sources":["file:///J:/projects/tree/packages/core/src/identity/domain/services/TokenService.ts"],"sourcesContent":["/**\r\n * TokenService\r\n * \r\n * Domain service for managing authentication tokens.\r\n * Handles token generation, verification, and refresh.\r\n */\r\n\r\nimport { AccessToken, AccessTokenPayload } from '../value-objects/AccessToken';\r\nimport { RefreshToken } from '../value-objects/RefreshToken';\r\n\r\nexport interface TokenPair {\r\n  accessToken: string;\r\n  refreshToken: string;\r\n}\r\n\r\nexport class TokenService {\r\n  /**\r\n   * Generate a new token pair (access + refresh)\r\n   */\r\n  public generateTokenPair(userId: string, email: string, role: string): TokenPair {\r\n    const accessTokenPayload: AccessTokenPayload = {\r\n      userId,\r\n      email,\r\n      role,\r\n    };\r\n\r\n    const accessToken = AccessToken.generate(accessTokenPayload);\r\n    const refreshToken = RefreshToken.generate(userId);\r\n\r\n    return {\r\n      accessToken: accessToken.getValue(),\r\n      refreshToken: refreshToken.getValue(),\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Verify an access token\r\n   */\r\n  public verifyAccessToken(token: string): AccessTokenPayload {\r\n    return AccessToken.verify(token);\r\n  }\r\n\r\n  /**\r\n   * Verify a refresh token\r\n   */\r\n  public verifyRefreshToken(token: string): { userId: string; tokenId: string } {\r\n    return RefreshToken.verify(token);\r\n  }\r\n\r\n  /**\r\n   * Refresh tokens - generate new pair from valid refresh token\r\n   */\r\n  public refreshTokens(\r\n    refreshTokenString: string,\r\n    email: string,\r\n    role: string\r\n  ): TokenPair {\r\n    // Verify the refresh token\r\n    const refreshToken = RefreshToken.fromString(refreshTokenString);\r\n    const userId = refreshToken.getUserId();\r\n\r\n    // Generate new token pair\r\n    return this.generateTokenPair(userId, email, role);\r\n  }\r\n\r\n  /**\r\n   * Extract token from Authorization header\r\n   */\r\n  public extractTokenFromHeader(authHeader: string | null): string | null {\r\n    if (!authHeader) {\r\n      return null;\r\n    }\r\n\r\n    // Expected format: \"Bearer <token>\"\r\n    const parts = authHeader.split(' ');\r\n\r\n    if (parts.length !== 2 || parts[0] !== 'Bearer') {\r\n      return null;\r\n    }\r\n\r\n    return parts[1];\r\n  }\r\n}\r\n"],"names":[],"mappings":"AAAA;;;;;CAKC;;;;AAED;AACA;;;AAOO,MAAM;IACX;;GAEC,GACD,AAAO,kBAAkB,MAAc,EAAE,KAAa,EAAE,IAAY,EAAa;QAC/E,MAAM,qBAAyC;YAC7C;YACA;YACA;QACF;QAEA,MAAM,cAAc,iMAAW,CAAC,QAAQ,CAAC;QACzC,MAAM,eAAe,mMAAY,CAAC,QAAQ,CAAC;QAE3C,OAAO;YACL,aAAa,YAAY,QAAQ;YACjC,cAAc,aAAa,QAAQ;QACrC;IACF;IAEA;;GAEC,GACD,AAAO,kBAAkB,KAAa,EAAsB;QAC1D,OAAO,iMAAW,CAAC,MAAM,CAAC;IAC5B;IAEA;;GAEC,GACD,AAAO,mBAAmB,KAAa,EAAuC;QAC5E,OAAO,mMAAY,CAAC,MAAM,CAAC;IAC7B;IAEA;;GAEC,GACD,AAAO,cACL,kBAA0B,EAC1B,KAAa,EACb,IAAY,EACD;QACX,2BAA2B;QAC3B,MAAM,eAAe,mMAAY,CAAC,UAAU,CAAC;QAC7C,MAAM,SAAS,aAAa,SAAS;QAErC,0BAA0B;QAC1B,OAAO,IAAI,CAAC,iBAAiB,CAAC,QAAQ,OAAO;IAC/C;IAEA;;GAEC,GACD,AAAO,uBAAuB,UAAyB,EAAiB;QACtE,IAAI,CAAC,YAAY;YACf,OAAO;QACT;QAEA,oCAAoC;QACpC,MAAM,QAAQ,WAAW,KAAK,CAAC;QAE/B,IAAI,MAAM,MAAM,KAAK,KAAK,KAAK,CAAC,EAAE,KAAK,UAAU;YAC/C,OAAO;QACT;QAEA,OAAO,KAAK,CAAC,EAAE;IACjB;AACF"}},
    {"offset": {"line": 1644, "column": 0}, "map": {"version":3,"sources":["file:///J:/projects/tree/apps/web/lib/middleware/auth.ts"],"sourcesContent":["/**\r\n * Authentication Middleware\r\n * \r\n * Verifies JWT tokens and attaches user information to requests.\r\n */\r\n\r\nimport { NextRequest } from 'next/server';\r\nimport { TokenService } from '@repo/core/identity/domain/services/TokenService';\r\n\r\nexport interface AuthenticatedRequest extends NextRequest {\r\n  user?: {\r\n    userId: string;\r\n    email: string;\r\n    role: string;\r\n  };\r\n}\r\n\r\n/**\r\n * Extract and verify JWT token from request\r\n */\r\nexport async function authenticateRequest(\r\n  request: NextRequest\r\n): Promise<{ userId: string; email: string; role: string }> {\r\n  const tokenService = new TokenService();\r\n\r\n  // Extract token from Authorization header\r\n  const authHeader = request.headers.get('Authorization');\r\n  const token = tokenService.extractTokenFromHeader(authHeader);\r\n\r\n  if (!token) {\r\n    throw new Error('No authentication token provided');\r\n  }\r\n\r\n  // Verify token\r\n  try {\r\n    const payload = tokenService.verifyAccessToken(token);\r\n\r\n    return {\r\n      userId: payload.userId,\r\n      email: payload.email,\r\n      role: payload.role,\r\n    };\r\n  } catch (error) {\r\n    console.error('Auth Middleware Error:', error);\r\n    // Debug: Check if secret is loaded\r\n    if (!process.env.JWT_SECRET) {\r\n      console.error('CRITICAL: JWT_SECRET is missing in environment variables!');\r\n    }\r\n\r\n    if (error instanceof Error) {\r\n      throw new Error(`Authentication failed: ${error.message}`);\r\n    }\r\n    throw new Error('Authentication failed');\r\n  }\r\n}\r\n\r\n/**\r\n * Middleware to require specific roles\r\n */\r\nexport function requireRole(allowedRoles: string[]) {\r\n  return async (request: AuthenticatedRequest) => {\r\n    const user = await authenticateRequest(request);\r\n\r\n    if (!allowedRoles.includes(user.role)) {\r\n      console.error(`Role mismatch: User role '${user.role}' is not in allowed roles: ${allowedRoles.join(', ')}`);\r\n      throw new Error(\r\n        `Forbidden: Requires one of the following roles: ${allowedRoles.join(', ')}`\r\n      );\r\n    }\r\n\r\n    return user;\r\n  };\r\n}\r\n\r\n/**\r\n * Common role checks\r\n */\r\nexport const requireAdmin = requireRole(['ADMIN']);\r\nexport const requireSeller = requireRole(['SELLER', 'ADMIN']);\r\nexport const requireAuthenticated = authenticateRequest;\r\n"],"names":[],"mappings":"AAAA;;;;CAIC;;;;;;;;;;;;AAGD;;AAaO,eAAe,oBACpB,OAAoB;IAEpB,MAAM,eAAe,IAAI,2LAAY;IAErC,0CAA0C;IAC1C,MAAM,aAAa,QAAQ,OAAO,CAAC,GAAG,CAAC;IACvC,MAAM,QAAQ,aAAa,sBAAsB,CAAC;IAElD,IAAI,CAAC,OAAO;QACV,MAAM,IAAI,MAAM;IAClB;IAEA,eAAe;IACf,IAAI;QACF,MAAM,UAAU,aAAa,iBAAiB,CAAC;QAE/C,OAAO;YACL,QAAQ,QAAQ,MAAM;YACtB,OAAO,QAAQ,KAAK;YACpB,MAAM,QAAQ,IAAI;QACpB;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,0BAA0B;QACxC,mCAAmC;QACnC,IAAI,CAAC,QAAQ,GAAG,CAAC,UAAU,EAAE;YAC3B,QAAQ,KAAK,CAAC;QAChB;QAEA,IAAI,iBAAiB,OAAO;YAC1B,MAAM,IAAI,MAAM,CAAC,uBAAuB,EAAE,MAAM,OAAO,EAAE;QAC3D;QACA,MAAM,IAAI,MAAM;IAClB;AACF;AAKO,SAAS,YAAY,YAAsB;IAChD,OAAO,OAAO;QACZ,MAAM,OAAO,MAAM,oBAAoB;QAEvC,IAAI,CAAC,aAAa,QAAQ,CAAC,KAAK,IAAI,GAAG;YACrC,QAAQ,KAAK,CAAC,CAAC,0BAA0B,EAAE,KAAK,IAAI,CAAC,2BAA2B,EAAE,aAAa,IAAI,CAAC,OAAO;YAC3G,MAAM,IAAI,MACR,CAAC,gDAAgD,EAAE,aAAa,IAAI,CAAC,OAAO;QAEhF;QAEA,OAAO;IACT;AACF;AAKO,MAAM,eAAe,YAAY;IAAC;CAAQ;AAC1C,MAAM,gBAAgB,YAAY;IAAC;IAAU;CAAQ;AACrD,MAAM,uBAAuB"}},
    {"offset": {"line": 1712, "column": 0}, "map": {"version":3,"sources":["file:///J:/projects/tree/apps/web/app/api/v1/orders/route.ts"],"sourcesContent":["/**\r\n * Orders API Routes\r\n * \r\n * POST /api/v1/orders - Create order\r\n * GET  /api/v1/orders - Get order history\r\n */\r\n\r\nimport { NextRequest, NextResponse } from 'next/server';\r\nimport { z } from 'zod';\r\nimport { prisma } from '@repo/database';\r\nimport { CreateOrderUseCase } from '@repo/core/orders/application/use-cases/CreateOrderUseCase';\r\nimport { GetOrderHistoryUseCase } from '@repo/core/orders/application/use-cases/GetOrderHistoryUseCase';\r\nimport { PrismaOrderRepository } from '@repo/core/orders/infrastructure/repositories/PrismaOrderRepository';\r\nimport { PrismaListingRepository } from '@repo/core/marketplace/infrastructure/repositories/PrismaListingRepository';\r\nimport { requireAuthenticated } from '@/lib/middleware/auth';\r\n\r\n// Validation Schemas\r\nconst CreateOrderSchema = z.object({\r\n  listingId: z.string().uuid('Invalid listing ID'),\r\n  quantity: z.number().int().positive('Quantity must be positive').max(1000),\r\n  shippingAddress: z.object({\r\n    fullName: z.string().min(2).max(100),\r\n    addressLine1: z.string().min(1),\r\n    addressLine2: z.string().optional(),\r\n    city: z.string().min(1),\r\n    state: z.string().min(1),\r\n    postalCode: z.string().min(3).max(10),\r\n    country: z.string().length(2),\r\n    phoneNumber: z.string().min(7).max(20),\r\n  }),\r\n  notes: z.string().optional(),\r\n});\r\n\r\nconst SearchOrdersSchema = z.object({\r\n  status: z.enum(['PENDING', 'PAID', 'PROCESSING', 'SHIPPED', 'DELIVERED', 'CANCELLED']).optional(),\r\n  fromDate: z.string().optional(),\r\n  toDate: z.string().optional(),\r\n  page: z.number().int().positive().optional(),\r\n  pageSize: z.number().int().positive().max(100).optional(),\r\n});\r\n\r\n/**\r\n * POST /api/v1/orders\r\n * Create a new order (PROTECTED)\r\n */\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    // 1. Authenticate\r\n    const user = await requireAuthenticated(request);\r\n\r\n    // 2. Parse and validate request body\r\n    const body = await request.json();\r\n    const validatedData = CreateOrderSchema.parse(body);\r\n\r\n    // 3. Initialize dependencies\r\n    const orderRepository = new PrismaOrderRepository(prisma);\r\n    const listingRepository = new PrismaListingRepository(prisma);\r\n    const useCase = new CreateOrderUseCase(orderRepository, listingRepository);\r\n\r\n    // 4. Execute use case\r\n    const result = await useCase.execute(user.userId, validatedData);\r\n\r\n    // 5. Return success response\r\n    return NextResponse.json(\r\n      {\r\n        success: true,\r\n        data: result,\r\n        message: 'Order created successfully',\r\n      },\r\n      { status: 201 }\r\n    );\r\n  } catch (error) {\r\n    // Handle authentication errors\r\n    if (error instanceof Error && error.message.includes('Authentication')) {\r\n      return NextResponse.json(\r\n        {\r\n          success: false,\r\n          error: error.message,\r\n        },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    // Handle validation errors\r\n    if (error instanceof z.ZodError) {\r\n      return NextResponse.json(\r\n        {\r\n          success: false,\r\n          error: 'Validation failed',\r\n          details: error.errors,\r\n        },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Handle business logic errors\r\n    if (error instanceof Error) {\r\n      return NextResponse.json(\r\n        {\r\n          success: false,\r\n          error: error.message,\r\n        },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Unknown error\r\n    console.error('Create order error:', error);\r\n    return NextResponse.json(\r\n      {\r\n        success: false,\r\n        error: 'Internal server error',\r\n      },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n/**\r\n * GET /api/v1/orders\r\n * Get order history (PROTECTED)\r\n */\r\nexport async function GET(request: NextRequest) {\r\n  try {\r\n    // 1. Authenticate\r\n    const user = await requireAuthenticated(request);\r\n\r\n    // 2. Parse query parameters\r\n    const { searchParams } = new URL(request.url);\r\n    const queryParams = {\r\n      status: searchParams.get('status') || undefined,\r\n      fromDate: searchParams.get('fromDate') || undefined,\r\n      toDate: searchParams.get('toDate') || undefined,\r\n      page: searchParams.get('page') ? parseInt(searchParams.get('page')!) : undefined,\r\n      pageSize: searchParams.get('pageSize') ? parseInt(searchParams.get('pageSize')!) : undefined,\r\n    };\r\n\r\n    const validatedParams = SearchOrdersSchema.parse(queryParams);\r\n\r\n    // 3. Initialize dependencies\r\n    const orderRepository = new PrismaOrderRepository(prisma);\r\n    const useCase = new GetOrderHistoryUseCase(orderRepository);\r\n\r\n    // 4. Determine role (buyer or seller)\r\n    const role: 'buyer' | 'seller' = user.role === 'SELLER' ? 'seller' : 'buyer';\r\n\r\n    // 5. Execute use case\r\n    const result = await useCase.execute(user.userId, validatedParams, role);\r\n\r\n    // 6. Return success response\r\n    return NextResponse.json({\r\n      success: true,\r\n      data: result,\r\n    });\r\n  } catch (error) {\r\n    // Handle authentication errors\r\n    if (error instanceof Error && error.message.includes('Authentication')) {\r\n      return NextResponse.json(\r\n        {\r\n          success: false,\r\n          error: error.message,\r\n        },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    // Handle validation errors\r\n    if (error instanceof z.ZodError) {\r\n      return NextResponse.json(\r\n        {\r\n          success: false,\r\n          error: 'Validation failed',\r\n          details: error.errors,\r\n        },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Unknown error\r\n    console.error('Get orders error:', error);\r\n    return NextResponse.json(\r\n      {\r\n        success: false,\r\n        error: 'Internal server error',\r\n      },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}