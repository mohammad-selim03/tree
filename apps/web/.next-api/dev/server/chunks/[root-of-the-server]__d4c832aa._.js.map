{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///J:/projects/tree/packages/database/src/index.ts"],"sourcesContent":["import { PrismaClient } from '@prisma/client';\r\n\r\nexport * from '@prisma/client';\r\n\r\nconst globalForPrisma = global as unknown as { prisma: PrismaClient };\r\n\r\nexport const prisma =\r\n    globalForPrisma.prisma ||\r\n    new PrismaClient({\r\n        log: ['query', 'error', 'warn'],\r\n    });\r\n\r\nif (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma;\r\n"],"names":[],"mappings":";;;;AAAA;;;AAIA,MAAM;AAEC,MAAM,SACT,gBAAgB,MAAM,IACtB,IAAI,6IAAY,CAAC;IACb,KAAK;QAAC;QAAS;QAAS;KAAO;AACnC;AAEJ,wCAA2C,gBAAgB,MAAM,GAAG"}},
    {"offset": {"line": 72, "column": 0}, "map": {"version":3,"sources":["file:///J:/projects/tree/packages/core/src/marketplace/domain/aggregates/Listing.ts"],"sourcesContent":["/**\r\n * Listing Aggregate Root\r\n * \r\n * Central aggregate for marketplace listings.\r\n * Manages product listings, inventory, pricing, and publication status.\r\n * Emits domain events for state changes.\r\n */\r\n\r\nimport { Money } from '../value-objects/Money';\r\n\r\nexport enum ListingStatus {\r\n  DRAFT = 'DRAFT',\r\n  ACTIVE = 'ACTIVE',\r\n  SOLD_OUT = 'SOLD_OUT',\r\n  FLAGGED = 'FLAGGED',\r\n  ARCHIVED = 'ARCHIVED',\r\n}\r\n\r\nexport interface DomainEvent {\r\n  type: string;\r\n  aggregateId: string;\r\n  occurredAt: Date;\r\n  data: any;\r\n}\r\n\r\nexport interface ListingProps {\r\n  id: string;\r\n  sellerId: string;\r\n  speciesId: string;\r\n  title: string;\r\n  description: string;\r\n  basePrice: Money;\r\n  inventory: number;\r\n  status: ListingStatus;\r\n  viewCount: number;\r\n  metadata?: object;\r\n  createdAt: Date;\r\n  updatedAt: Date;\r\n  publishedAt?: Date;\r\n}\r\n\r\nexport class Listing {\r\n  private props: ListingProps;\r\n  private domainEvents: DomainEvent[] = [];\r\n\r\n  private constructor(props: ListingProps) {\r\n    this.props = props;\r\n  }\r\n\r\n  /**\r\n   * Create a new listing (starts in DRAFT status)\r\n   */\r\n  public static create(\r\n    props: Omit<ListingProps, 'id' | 'status' | 'viewCount' | 'createdAt' | 'updatedAt'>\r\n  ): Listing {\r\n    // Validate title\r\n    if (!props.title || props.title.trim().length === 0) {\r\n      throw new Error('Title cannot be empty');\r\n    }\r\n    if (props.title.length < 10) {\r\n      throw new Error('Title must be at least 10 characters');\r\n    }\r\n    if (props.title.length > 200) {\r\n      throw new Error('Title cannot exceed 200 characters');\r\n    }\r\n\r\n    // Validate description\r\n    if (!props.description || props.description.trim().length === 0) {\r\n      throw new Error('Description cannot be empty');\r\n    }\r\n    if (props.description.length < 50) {\r\n      throw new Error('Description must be at least 50 characters');\r\n    }\r\n\r\n    // Validate price\r\n    if (props.basePrice.isZero() || props.basePrice.getAmount() <= 0) {\r\n      throw new Error('Base price must be greater than zero');\r\n    }\r\n\r\n    // Validate inventory\r\n    if (props.inventory < 0) {\r\n      throw new Error('Inventory cannot be negative');\r\n    }\r\n\r\n    const listing = new Listing({\r\n      ...props,\r\n      id: crypto.randomUUID(),\r\n      status: ListingStatus.DRAFT,\r\n      viewCount: 0,\r\n      createdAt: new Date(),\r\n      updatedAt: new Date(),\r\n    });\r\n\r\n    listing.addDomainEvent({\r\n      type: 'ListingCreated',\r\n      aggregateId: listing.id,\r\n      occurredAt: new Date(),\r\n      data: {\r\n        listingId: listing.id,\r\n        sellerId: listing.sellerId,\r\n        title: listing.title,\r\n      },\r\n    });\r\n\r\n    return listing;\r\n  }\r\n\r\n  /**\r\n   * Reconstitute a listing from persistence\r\n   */\r\n  public static reconstitute(props: ListingProps): Listing {\r\n    return new Listing(props);\r\n  }\r\n\r\n  /**\r\n   * Publish the listing (make it visible to buyers)\r\n   */\r\n  public publish(): void {\r\n    if (this.props.inventory === 0) {\r\n      throw new Error('Cannot publish listing with zero inventory');\r\n    }\r\n\r\n    if (this.props.status !== ListingStatus.DRAFT) {\r\n      throw new Error('Only draft listings can be published');\r\n    }\r\n\r\n    this.props.status = ListingStatus.ACTIVE;\r\n    this.props.publishedAt = new Date();\r\n    this.props.updatedAt = new Date();\r\n\r\n    this.addDomainEvent({\r\n      type: 'ListingPublished',\r\n      aggregateId: this.props.id,\r\n      occurredAt: new Date(),\r\n      data: {\r\n        listingId: this.props.id,\r\n        publishedAt: this.props.publishedAt,\r\n      },\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Update listing details\r\n   */\r\n  public updateDetails(title: string, description: string): void {\r\n    if (this.props.status === ListingStatus.ARCHIVED) {\r\n      throw new Error('Cannot update archived listing');\r\n    }\r\n\r\n    if (title && title.length >= 10 && title.length <= 200) {\r\n      this.props.title = title;\r\n    }\r\n\r\n    if (description && description.length >= 50) {\r\n      this.props.description = description;\r\n    }\r\n\r\n    this.props.updatedAt = new Date();\r\n  }\r\n\r\n  /**\r\n   * Update the base price\r\n   */\r\n  public updatePrice(newPrice: Money): void {\r\n    if (this.props.status === ListingStatus.ARCHIVED) {\r\n      throw new Error('Cannot update price of archived listing');\r\n    }\r\n\r\n    if (newPrice.isZero() || newPrice.getAmount() <= 0) {\r\n      throw new Error('Price must be greater than zero');\r\n    }\r\n\r\n    this.props.basePrice = newPrice;\r\n    this.props.updatedAt = new Date();\r\n\r\n    this.addDomainEvent({\r\n      type: 'ListingPriceUpdated',\r\n      aggregateId: this.props.id,\r\n      occurredAt: new Date(),\r\n      data: {\r\n        listingId: this.props.id,\r\n        newPrice: newPrice.getAmount(),\r\n        currency: newPrice.getCurrency(),\r\n      },\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Set inventory to a specific amount\r\n   */\r\n  public updateInventory(quantity: number): void {\r\n    if (quantity < 0) {\r\n      throw new Error('Inventory cannot be negative');\r\n    }\r\n\r\n    const previousInventory = this.props.inventory;\r\n    this.props.inventory = quantity;\r\n    this.props.updatedAt = new Date();\r\n\r\n    // If inventory drops to zero, mark as sold out\r\n    if (quantity === 0 && this.props.status === ListingStatus.ACTIVE) {\r\n      this.markAsSoldOut();\r\n    }\r\n\r\n    // If inventory was zero and now has stock, reactivate\r\n    if (previousInventory === 0 && quantity > 0 && this.props.status === ListingStatus.SOLD_OUT) {\r\n      this.props.status = ListingStatus.ACTIVE;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Decrease inventory by a specific amount (e.g., after purchase)\r\n   */\r\n  public decreaseInventory(amount: number): void {\r\n    if (amount <= 0) {\r\n      throw new Error('Amount to decrease must be positive');\r\n    }\r\n\r\n    const newInventory = this.props.inventory - amount;\r\n    if (newInventory < 0) {\r\n      throw new Error('Insufficient inventory');\r\n    }\r\n\r\n    this.updateInventory(newInventory);\r\n  }\r\n\r\n  /**\r\n   * Increase inventory by a specific amount (e.g., restock)\r\n   */\r\n  public increaseInventory(amount: number): void {\r\n    if (amount <= 0) {\r\n      throw new Error('Amount to increase must be positive');\r\n    }\r\n\r\n    this.updateInventory(this.props.inventory + amount);\r\n  }\r\n\r\n  /**\r\n   * Increment view count (for analytics)\r\n   */\r\n  public incrementViewCount(): void {\r\n    this.props.viewCount += 1;\r\n  }\r\n\r\n  /**\r\n   * Flag the listing (e.g., for fraud, policy violation)\r\n   */\r\n  public flag(reason: string): void {\r\n    if (!reason || reason.trim().length === 0) {\r\n      throw new Error('Flag reason is required');\r\n    }\r\n\r\n    this.props.status = ListingStatus.FLAGGED;\r\n    this.props.updatedAt = new Date();\r\n\r\n    this.addDomainEvent({\r\n      type: 'ListingFlagged',\r\n      aggregateId: this.props.id,\r\n      occurredAt: new Date(),\r\n      data: {\r\n        listingId: this.props.id,\r\n        reason,\r\n      },\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Unflag the listing (after review)\r\n   */\r\n  public unflag(): void {\r\n    if (this.props.status !== ListingStatus.FLAGGED) {\r\n      throw new Error('Listing is not flagged');\r\n    }\r\n\r\n    // Return to previous status based on inventory\r\n    this.props.status = this.props.inventory > 0 ? ListingStatus.ACTIVE : ListingStatus.DRAFT;\r\n    this.props.updatedAt = new Date();\r\n  }\r\n\r\n  /**\r\n   * Archive the listing (soft delete)\r\n   */\r\n  public archive(): void {\r\n    this.props.status = ListingStatus.ARCHIVED;\r\n    this.props.updatedAt = new Date();\r\n\r\n    this.addDomainEvent({\r\n      type: 'ListingArchived',\r\n      aggregateId: this.props.id,\r\n      occurredAt: new Date(),\r\n      data: {\r\n        listingId: this.props.id,\r\n      },\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Mark listing as sold out\r\n   */\r\n  private markAsSoldOut(): void {\r\n    this.props.status = ListingStatus.SOLD_OUT;\r\n\r\n    this.addDomainEvent({\r\n      type: 'ListingSoldOut',\r\n      aggregateId: this.props.id,\r\n      occurredAt: new Date(),\r\n      data: {\r\n        listingId: this.props.id,\r\n      },\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Check if listing is available for purchase\r\n   */\r\n  public isAvailable(): boolean {\r\n    return this.props.status === ListingStatus.ACTIVE && this.props.inventory > 0;\r\n  }\r\n\r\n  /**\r\n   * Check if listing is visible to buyers\r\n   */\r\n  public isVisible(): boolean {\r\n    return this.props.status === ListingStatus.ACTIVE || this.props.status === ListingStatus.SOLD_OUT;\r\n  }\r\n\r\n  /**\r\n   * Update metadata (SEO, tags, etc.)\r\n   */\r\n  public updateMetadata(metadata: object): void {\r\n    this.props.metadata = metadata;\r\n    this.props.updatedAt = new Date();\r\n  }\r\n\r\n  // Domain Events Management\r\n  private addDomainEvent(event: DomainEvent): void {\r\n    this.domainEvents.push(event);\r\n  }\r\n\r\n  public getDomainEvents(): readonly DomainEvent[] {\r\n    return [...this.domainEvents];\r\n  }\r\n\r\n  public clearDomainEvents(): void {\r\n    this.domainEvents = [];\r\n  }\r\n\r\n  // Getters\r\n  get id(): string {\r\n    return this.props.id;\r\n  }\r\n\r\n  get sellerId(): string {\r\n    return this.props.sellerId;\r\n  }\r\n\r\n  get speciesId(): string {\r\n    return this.props.speciesId;\r\n  }\r\n\r\n  get title(): string {\r\n    return this.props.title;\r\n  }\r\n\r\n  get description(): string {\r\n    return this.props.description;\r\n  }\r\n\r\n  get basePrice(): Money {\r\n    return this.props.basePrice;\r\n  }\r\n\r\n  get inventory(): number {\r\n    return this.props.inventory;\r\n  }\r\n\r\n  get status(): ListingStatus {\r\n    return this.props.status;\r\n  }\r\n\r\n  get viewCount(): number {\r\n    return this.props.viewCount;\r\n  }\r\n\r\n  get metadata(): object | undefined {\r\n    return this.props.metadata;\r\n  }\r\n\r\n  get createdAt(): Date {\r\n    return this.props.createdAt;\r\n  }\r\n\r\n  get updatedAt(): Date {\r\n    return this.props.updatedAt;\r\n  }\r\n\r\n  get publishedAt(): Date | undefined {\r\n    return this.props.publishedAt;\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 380, "column": 0}, "map": {"version":3,"sources":["file:///J:/projects/tree/packages/core/src/marketplace/domain/value-objects/Money.ts"],"sourcesContent":["/**\r\n * Money Value Object\r\n * \r\n * Represents monetary value with currency.\r\n * Ensures money operations are type-safe and currency-aware.\r\n */\r\n\r\nexport class Money {\r\n  private readonly amount: number;\r\n  private readonly currency: string;\r\n\r\n  private constructor(amount: number, currency: string = 'USD') {\r\n    if (amount < 0) {\r\n      throw new Error('Money amount cannot be negative');\r\n    }\r\n    if (!currency || currency.length !== 3) {\r\n      throw new Error('Currency must be a valid 3-letter code');\r\n    }\r\n    this.amount = amount;\r\n    this.currency = currency.toUpperCase();\r\n  }\r\n\r\n  public static create(amount: number, currency: string = 'USD'): Money {\r\n    return new Money(amount, currency);\r\n  }\r\n\r\n  public static zero(currency: string = 'USD'): Money {\r\n    return new Money(0, currency);\r\n  }\r\n\r\n  public getAmount(): number {\r\n    return this.amount;\r\n  }\r\n\r\n  public getCurrency(): string {\r\n    return this.currency;\r\n  }\r\n\r\n  public add(other: Money): Money {\r\n    this.assertSameCurrency(other);\r\n    return Money.create(this.amount + other.amount, this.currency);\r\n  }\r\n\r\n  public subtract(other: Money): Money {\r\n    this.assertSameCurrency(other);\r\n    const result = this.amount - other.amount;\r\n    if (result < 0) {\r\n      throw new Error('Subtraction would result in negative money');\r\n    }\r\n    return Money.create(result, this.currency);\r\n  }\r\n\r\n  public multiply(factor: number): Money {\r\n    if (factor < 0) {\r\n      throw new Error('Cannot multiply money by negative factor');\r\n    }\r\n    return Money.create(this.amount * factor, this.currency);\r\n  }\r\n\r\n  public divide(divisor: number): Money {\r\n    if (divisor <= 0) {\r\n      throw new Error('Cannot divide money by zero or negative number');\r\n    }\r\n    return Money.create(this.amount / divisor, this.currency);\r\n  }\r\n\r\n  public isGreaterThan(other: Money): boolean {\r\n    this.assertSameCurrency(other);\r\n    return this.amount > other.amount;\r\n  }\r\n\r\n  public isLessThan(other: Money): boolean {\r\n    this.assertSameCurrency(other);\r\n    return this.amount < other.amount;\r\n  }\r\n\r\n  public equals(other: Money): boolean {\r\n    return this.amount === other.amount && this.currency === other.currency;\r\n  }\r\n\r\n  public isZero(): boolean {\r\n    return this.amount === 0;\r\n  }\r\n\r\n  public toString(): string {\r\n    return `${this.currency} ${this.amount.toFixed(2)}`;\r\n  }\r\n\r\n  private assertSameCurrency(other: Money): void {\r\n    if (this.currency !== other.currency) {\r\n      throw new Error(\r\n        `Cannot perform operation on different currencies: ${this.currency} and ${other.currency}`\r\n      );\r\n    }\r\n  }\r\n}\r\n"],"names":[],"mappings":"AAAA;;;;;CAKC;;;;AAEM,MAAM;IACM,OAAe;IACf,SAAiB;IAElC,YAAoB,MAAc,EAAE,WAAmB,KAAK,CAAE;QAC5D,IAAI,SAAS,GAAG;YACd,MAAM,IAAI,MAAM;QAClB;QACA,IAAI,CAAC,YAAY,SAAS,MAAM,KAAK,GAAG;YACtC,MAAM,IAAI,MAAM;QAClB;QACA,IAAI,CAAC,MAAM,GAAG;QACd,IAAI,CAAC,QAAQ,GAAG,SAAS,WAAW;IACtC;IAEA,OAAc,OAAO,MAAc,EAAE,WAAmB,KAAK,EAAS;QACpE,OAAO,IAAI,MAAM,QAAQ;IAC3B;IAEA,OAAc,KAAK,WAAmB,KAAK,EAAS;QAClD,OAAO,IAAI,MAAM,GAAG;IACtB;IAEO,YAAoB;QACzB,OAAO,IAAI,CAAC,MAAM;IACpB;IAEO,cAAsB;QAC3B,OAAO,IAAI,CAAC,QAAQ;IACtB;IAEO,IAAI,KAAY,EAAS;QAC9B,IAAI,CAAC,kBAAkB,CAAC;QACxB,OAAO,MAAM,MAAM,CAAC,IAAI,CAAC,MAAM,GAAG,MAAM,MAAM,EAAE,IAAI,CAAC,QAAQ;IAC/D;IAEO,SAAS,KAAY,EAAS;QACnC,IAAI,CAAC,kBAAkB,CAAC;QACxB,MAAM,SAAS,IAAI,CAAC,MAAM,GAAG,MAAM,MAAM;QACzC,IAAI,SAAS,GAAG;YACd,MAAM,IAAI,MAAM;QAClB;QACA,OAAO,MAAM,MAAM,CAAC,QAAQ,IAAI,CAAC,QAAQ;IAC3C;IAEO,SAAS,MAAc,EAAS;QACrC,IAAI,SAAS,GAAG;YACd,MAAM,IAAI,MAAM;QAClB;QACA,OAAO,MAAM,MAAM,CAAC,IAAI,CAAC,MAAM,GAAG,QAAQ,IAAI,CAAC,QAAQ;IACzD;IAEO,OAAO,OAAe,EAAS;QACpC,IAAI,WAAW,GAAG;YAChB,MAAM,IAAI,MAAM;QAClB;QACA,OAAO,MAAM,MAAM,CAAC,IAAI,CAAC,MAAM,GAAG,SAAS,IAAI,CAAC,QAAQ;IAC1D;IAEO,cAAc,KAAY,EAAW;QAC1C,IAAI,CAAC,kBAAkB,CAAC;QACxB,OAAO,IAAI,CAAC,MAAM,GAAG,MAAM,MAAM;IACnC;IAEO,WAAW,KAAY,EAAW;QACvC,IAAI,CAAC,kBAAkB,CAAC;QACxB,OAAO,IAAI,CAAC,MAAM,GAAG,MAAM,MAAM;IACnC;IAEO,OAAO,KAAY,EAAW;QACnC,OAAO,IAAI,CAAC,MAAM,KAAK,MAAM,MAAM,IAAI,IAAI,CAAC,QAAQ,KAAK,MAAM,QAAQ;IACzE;IAEO,SAAkB;QACvB,OAAO,IAAI,CAAC,MAAM,KAAK;IACzB;IAEO,WAAmB;QACxB,OAAO,GAAG,IAAI,CAAC,QAAQ,CAAC,CAAC,EAAE,IAAI,CAAC,MAAM,CAAC,OAAO,CAAC,IAAI;IACrD;IAEQ,mBAAmB,KAAY,EAAQ;QAC7C,IAAI,IAAI,CAAC,QAAQ,KAAK,MAAM,QAAQ,EAAE;YACpC,MAAM,IAAI,MACR,CAAC,kDAAkD,EAAE,IAAI,CAAC,QAAQ,CAAC,KAAK,EAAE,MAAM,QAAQ,EAAE;QAE9F;IACF;AACF"}},
    {"offset": {"line": 465, "column": 0}, "map": {"version":3,"sources":["file:///J:/projects/tree/packages/core/src/marketplace/application/use-cases/CreateListingUseCase.ts"],"sourcesContent":["/**\r\n * Create Listing Use Case\r\n * \r\n * Handles the business logic for creating a new listing.\r\n * Validates seller exists and delegates to domain entity for creation.\r\n */\r\n\r\nimport { IListingRepository } from '../../domain/repositories/IListingRepository';\r\nimport { ISellerRepository } from '../../domain/repositories/ISellerRepository';\r\nimport { Listing } from '../../domain/aggregates/Listing';\r\nimport { Money } from '../../domain/value-objects/Money';\r\nimport { CreateListingDTO, ListingResponseDTO } from '../dtos/ListingDTO';\r\n\r\nexport class CreateListingUseCase {\r\n  constructor(\r\n    private listingRepository: IListingRepository,\r\n    private sellerRepository: ISellerRepository\r\n  ) {}\r\n\r\n  async execute(dto: CreateListingDTO): Promise<ListingResponseDTO> {\r\n    // 1. Verify seller exists and is active\r\n    const seller = await this.sellerRepository.findById(dto.sellerId);\r\n    if (!seller) {\r\n      throw new Error('Seller not found');\r\n    }\r\n\r\n    if (!seller.verified) {\r\n      throw new Error('Only verified sellers can create listings');\r\n    }\r\n\r\n    // 2. Create listing domain object\r\n    const listing = Listing.create({\r\n      sellerId: dto.sellerId,\r\n      speciesId: dto.speciesId,\r\n      title: dto.title,\r\n      description: dto.description,\r\n      basePrice: Money.create(dto.basePrice, 'USD'),\r\n      inventory: dto.inventory,\r\n      metadata: dto.metadata,\r\n    });\r\n\r\n    // 3. Persist listing\r\n    await this.listingRepository.save(listing);\r\n\r\n    // 4. Return DTO\r\n    return this.toResponseDTO(listing);\r\n  }\r\n\r\n  private toResponseDTO(listing: Listing): ListingResponseDTO {\r\n    return {\r\n      id: listing.id,\r\n      sellerId: listing.sellerId,\r\n      speciesId: listing.speciesId,\r\n      title: listing.title,\r\n      description: listing.description,\r\n      basePrice: listing.basePrice.getAmount(),\r\n      currency: listing.basePrice.getCurrency(),\r\n      inventory: listing.inventory,\r\n      status: listing.status,\r\n      viewCount: listing.viewCount,\r\n      metadata: listing.metadata,\r\n      publishedAt: listing.publishedAt?.toISOString(),\r\n      createdAt: listing.createdAt.toISOString(),\r\n      updatedAt: listing.updatedAt.toISOString(),\r\n    };\r\n  }\r\n}\r\n"],"names":[],"mappings":"AAAA;;;;;CAKC;;;;AAID;AACA;;;AAGO,MAAM;;;IACX,YACE,AAAQ,iBAAqC,EAC7C,AAAQ,gBAAmC,CAC3C;aAFQ,oBAAA;aACA,mBAAA;IACP;IAEH,MAAM,QAAQ,GAAqB,EAA+B;QAChE,wCAAwC;QACxC,MAAM,SAAS,MAAM,IAAI,CAAC,gBAAgB,CAAC,QAAQ,CAAC,IAAI,QAAQ;QAChE,IAAI,CAAC,QAAQ;YACX,MAAM,IAAI,MAAM;QAClB;QAEA,IAAI,CAAC,OAAO,QAAQ,EAAE;YACpB,MAAM,IAAI,MAAM;QAClB;QAEA,kCAAkC;QAClC,MAAM,UAAU,sLAAO,CAAC,MAAM,CAAC;YAC7B,UAAU,IAAI,QAAQ;YACtB,WAAW,IAAI,SAAS;YACxB,OAAO,IAAI,KAAK;YAChB,aAAa,IAAI,WAAW;YAC5B,WAAW,wLAAK,CAAC,MAAM,CAAC,IAAI,SAAS,EAAE;YACvC,WAAW,IAAI,SAAS;YACxB,UAAU,IAAI,QAAQ;QACxB;QAEA,qBAAqB;QACrB,MAAM,IAAI,CAAC,iBAAiB,CAAC,IAAI,CAAC;QAElC,gBAAgB;QAChB,OAAO,IAAI,CAAC,aAAa,CAAC;IAC5B;IAEQ,cAAc,OAAgB,EAAsB;QAC1D,OAAO;YACL,IAAI,QAAQ,EAAE;YACd,UAAU,QAAQ,QAAQ;YAC1B,WAAW,QAAQ,SAAS;YAC5B,OAAO,QAAQ,KAAK;YACpB,aAAa,QAAQ,WAAW;YAChC,WAAW,QAAQ,SAAS,CAAC,SAAS;YACtC,UAAU,QAAQ,SAAS,CAAC,WAAW;YACvC,WAAW,QAAQ,SAAS;YAC5B,QAAQ,QAAQ,MAAM;YACtB,WAAW,QAAQ,SAAS;YAC5B,UAAU,QAAQ,QAAQ;YAC1B,aAAa,QAAQ,WAAW,EAAE;YAClC,WAAW,QAAQ,SAAS,CAAC,WAAW;YACxC,WAAW,QAAQ,SAAS,CAAC,WAAW;QAC1C;IACF;AACF"}},
    {"offset": {"line": 532, "column": 0}, "map": {"version":3,"sources":["file:///J:/projects/tree/packages/core/src/marketplace/application/use-cases/SearchListingsUseCase.ts"],"sourcesContent":["/**\r\n * Search Listings Use Case\r\n * \r\n * Search and filter listings with pagination.\r\n */\r\n\r\nimport { IListingRepository } from '../../domain/repositories/IListingRepository';\r\nimport { SearchListingsDTO, ListingSearchResponseDTO, ListingResponseDTO } from '../dtos/ListingDTO';\r\n\r\nexport class SearchListingsUseCase {\r\n  constructor(private listingRepository: IListingRepository) {}\r\n\r\n  async execute(dto: SearchListingsDTO): Promise<ListingSearchResponseDTO> {\r\n    // Set defaults\r\n    const page = dto.page ?? 1;\r\n    const pageSize = dto.pageSize ?? 20;\r\n    const offset = (page - 1) * pageSize;\r\n\r\n    // Execute search\r\n    const result = await this.listingRepository.search({\r\n      speciesId: dto.speciesId,\r\n      sellerId: dto.sellerId,\r\n      status: dto.status ?? 'ACTIVE', // Default to showing only active listings\r\n      minPrice: dto.minPrice,\r\n      maxPrice: dto.maxPrice,\r\n      searchTerm: dto.searchTerm,\r\n      limit: pageSize,\r\n      offset,\r\n    });\r\n\r\n    // Calculate total pages\r\n    const totalPages = Math.ceil(result.total / pageSize);\r\n\r\n    // Map to response DTOs\r\n    const listings = result.listings.map(listing => this.toResponseDTO(listing));\r\n\r\n    return {\r\n      listings,\r\n      total: result.total,\r\n      page,\r\n      pageSize,\r\n      totalPages,\r\n    };\r\n  }\r\n\r\n  private toResponseDTO(listing: any): ListingResponseDTO {\r\n    return {\r\n      id: listing.id,\r\n      sellerId: listing.sellerId,\r\n      speciesId: listing.speciesId,\r\n      title: listing.title,\r\n      description: listing.description,\r\n      basePrice: listing.basePrice.getAmount(),\r\n      currency: listing.basePrice.getCurrency(),\r\n      inventory: listing.inventory,\r\n      status: listing.status,\r\n      viewCount: listing.viewCount,\r\n      metadata: listing.metadata,\r\n      publishedAt: listing.publishedAt?.toISOString(),\r\n      createdAt: listing.createdAt.toISOString(),\r\n      updatedAt: listing.updatedAt.toISOString(),\r\n    };\r\n  }\r\n}\r\n"],"names":[],"mappings":"AAAA;;;;CAIC;;;;AAKM,MAAM;;IACX,YAAY,AAAQ,iBAAqC,CAAE;aAAvC,oBAAA;IAAwC;IAE5D,MAAM,QAAQ,GAAsB,EAAqC;QACvE,eAAe;QACf,MAAM,OAAO,IAAI,IAAI,IAAI;QACzB,MAAM,WAAW,IAAI,QAAQ,IAAI;QACjC,MAAM,SAAS,CAAC,OAAO,CAAC,IAAI;QAE5B,iBAAiB;QACjB,MAAM,SAAS,MAAM,IAAI,CAAC,iBAAiB,CAAC,MAAM,CAAC;YACjD,WAAW,IAAI,SAAS;YACxB,UAAU,IAAI,QAAQ;YACtB,QAAQ,IAAI,MAAM,IAAI;YACtB,UAAU,IAAI,QAAQ;YACtB,UAAU,IAAI,QAAQ;YACtB,YAAY,IAAI,UAAU;YAC1B,OAAO;YACP;QACF;QAEA,wBAAwB;QACxB,MAAM,aAAa,KAAK,IAAI,CAAC,OAAO,KAAK,GAAG;QAE5C,uBAAuB;QACvB,MAAM,WAAW,OAAO,QAAQ,CAAC,GAAG,CAAC,CAAA,UAAW,IAAI,CAAC,aAAa,CAAC;QAEnE,OAAO;YACL;YACA,OAAO,OAAO,KAAK;YACnB;YACA;YACA;QACF;IACF;IAEQ,cAAc,OAAY,EAAsB;QACtD,OAAO;YACL,IAAI,QAAQ,EAAE;YACd,UAAU,QAAQ,QAAQ;YAC1B,WAAW,QAAQ,SAAS;YAC5B,OAAO,QAAQ,KAAK;YACpB,aAAa,QAAQ,WAAW;YAChC,WAAW,QAAQ,SAAS,CAAC,SAAS;YACtC,UAAU,QAAQ,SAAS,CAAC,WAAW;YACvC,WAAW,QAAQ,SAAS;YAC5B,QAAQ,QAAQ,MAAM;YACtB,WAAW,QAAQ,SAAS;YAC5B,UAAU,QAAQ,QAAQ;YAC1B,aAAa,QAAQ,WAAW,EAAE;YAClC,WAAW,QAAQ,SAAS,CAAC,WAAW;YACxC,WAAW,QAAQ,SAAS,CAAC,WAAW;QAC1C;IACF;AACF"}},
    {"offset": {"line": 596, "column": 0}, "map": {"version":3,"sources":["file:///J:/projects/tree/packages/core/src/marketplace/infrastructure/repositories/PrismaListingRepository.ts"],"sourcesContent":["/**\r\n * Prisma Listing Repository Implementation\r\n * \r\n * Implements IListingRepository using Prisma ORM.\r\n * Handles mapping between domain entities and database models.\r\n */\r\n\r\nimport { PrismaClient } from '@repo/database';\r\nimport { IListingRepository, ListingSearchFilters, ListingSearchResult } from '../../domain/repositories/IListingRepository';\r\nimport { Listing, ListingStatus } from '../../domain/aggregates/Listing';\r\nimport { Money } from '../../domain/value-objects/Money';\r\n\r\nexport class PrismaListingRepository implements IListingRepository {\r\n  constructor(private prisma: PrismaClient) {}\r\n\r\n  async findById(id: string): Promise<Listing | null> {\r\n    const data = await this.prisma.listing.findUnique({\r\n      where: { id, deletedAt: null },\r\n    });\r\n\r\n    if (!data) return null;\r\n\r\n    return this.toDomain(data);\r\n  }\r\n\r\n  async findByIds(ids: string[]): Promise<Listing[]> {\r\n    const data = await this.prisma.listing.findMany({\r\n      where: { \r\n        id: { in: ids },\r\n        deletedAt: null,\r\n      },\r\n    });\r\n\r\n    return data.map((d: any) => this.toDomain(d));\r\n  }\r\n\r\n  async findBySellerId(sellerId: string): Promise<Listing[]> {\r\n    const data = await this.prisma.listing.findMany({\r\n      where: { \r\n        sellerId,\r\n        deletedAt: null,\r\n      },\r\n      orderBy: { createdAt: 'desc' },\r\n    });\r\n\r\n    return data.map((d: any) => this.toDomain(d));\r\n  }\r\n\r\n  async findBySpeciesId(speciesId: string): Promise<Listing[]> {\r\n    const data = await this.prisma.listing.findMany({\r\n      where: { \r\n        speciesId,\r\n        deletedAt: null,\r\n      },\r\n      orderBy: { createdAt: 'desc' },\r\n    });\r\n\r\n    return data.map((d: any) => this.toDomain(d));\r\n  }\r\n\r\n  async search(filters: ListingSearchFilters): Promise<ListingSearchResult> {\r\n    const where: any = { deletedAt: null };\r\n\r\n    if (filters.speciesId) {\r\n      where.speciesId = filters.speciesId;\r\n    }\r\n\r\n    if (filters.sellerId) {\r\n      where.sellerId = filters.sellerId;\r\n    }\r\n\r\n    if (filters.status) {\r\n      where.status = filters.status;\r\n    }\r\n\r\n    if (filters.minPrice !== undefined || filters.maxPrice !== undefined) {\r\n      where.basePrice = {};\r\n      if (filters.minPrice !== undefined) {\r\n        where.basePrice.gte = filters.minPrice;\r\n      }\r\n      if (filters.maxPrice !== undefined) {\r\n        where.basePrice.lte = filters.maxPrice;\r\n      }\r\n    }\r\n\r\n    if (filters.searchTerm) {\r\n      where.OR = [\r\n        { title: { contains: filters.searchTerm, mode: 'insensitive' } },\r\n        { description: { contains: filters.searchTerm, mode: 'insensitive' } },\r\n      ];\r\n    }\r\n\r\n    const limit = filters.limit ?? 20;\r\n    const offset = filters.offset ?? 0;\r\n\r\n    const [data, total] = await Promise.all([\r\n      this.prisma.listing.findMany({\r\n        where,\r\n        take: limit,\r\n        skip: offset,\r\n        orderBy: { \r\n          publishedAt: { sort: 'desc', nulls: 'last' },\r\n        },\r\n      }),\r\n      this.prisma.listing.count({ where }),\r\n    ]);\r\n\r\n    return {\r\n      listings: data.map((d: any) => this.toDomain(d)),\r\n      total,\r\n      limit,\r\n      offset,\r\n    };\r\n  }\r\n\r\n  async save(listing: Listing): Promise<void> {\r\n    const data = this.toPersistence(listing);\r\n\r\n    await this.prisma.listing.upsert({\r\n      where: { id: listing.id },\r\n      create: data,\r\n      update: {\r\n        title: data.title,\r\n        description: data.description,\r\n        basePrice: data.basePrice,\r\n        inventory: data.inventory,\r\n        status: data.status,\r\n        viewCount: data.viewCount,\r\n        metadata: data.metadata,\r\n        publishedAt: data.publishedAt,\r\n        updatedAt: data.updatedAt,\r\n      },\r\n    });\r\n\r\n    // In a real implementation, you would also persist domain events here\r\n    // For now, we'll just clear them\r\n    listing.clearDomainEvents();\r\n  }\r\n\r\n  async delete(id: string): Promise<void> {\r\n    await this.prisma.listing.update({\r\n      where: { id },\r\n      data: { deletedAt: new Date() },\r\n    });\r\n  }\r\n\r\n  async count(status?: string): Promise<number> {\r\n    const where: any = { deletedAt: null };\r\n    \r\n    if (status) {\r\n      where.status = status;\r\n    }\r\n\r\n    return this.prisma.listing.count({ where });\r\n  }\r\n\r\n  async findNeedingAttention(): Promise<Listing[]> {\r\n    const data = await this.prisma.listing.findMany({\r\n      where: {\r\n        deletedAt: null,\r\n        OR: [\r\n          { status: 'FLAGGED' },\r\n          { status: 'SOLD_OUT' },\r\n          {\r\n            status: 'ACTIVE',\r\n            inventory: { lte: 5 }, // Low inventory warning\r\n          },\r\n        ],\r\n      },\r\n      orderBy: { updatedAt: 'desc' },\r\n    });\r\n\r\n    return data.map((d: any) => this.toDomain(d));\r\n  }\r\n\r\n  /**\r\n   * Convert Prisma model to Domain entity\r\n   */\r\n  private toDomain(data: any): Listing {\r\n    return Listing.reconstitute({\r\n      id: data.id,\r\n      sellerId: data.sellerId,\r\n      speciesId: data.speciesId,\r\n      title: data.title,\r\n      description: data.description,\r\n      basePrice: Money.create(Number(data.basePrice), 'USD'),\r\n      inventory: data.inventory,\r\n      status: data.status as ListingStatus,\r\n      viewCount: data.viewCount,\r\n      metadata: data.metadata as object | undefined,\r\n      createdAt: data.createdAt,\r\n      updatedAt: data.updatedAt,\r\n      publishedAt: data.publishedAt ?? undefined,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Convert Domain entity to Prisma model data\r\n   */\r\n  private toPersistence(listing: Listing): any {\r\n    return {\r\n      id: listing.id,\r\n      sellerId: listing.sellerId,\r\n      speciesId: listing.speciesId,\r\n      title: listing.title,\r\n      description: listing.description,\r\n      basePrice: listing.basePrice.getAmount(),\r\n      inventory: listing.inventory,\r\n      status: listing.status,\r\n      viewCount: listing.viewCount,\r\n      metadata: listing.metadata ?? null,\r\n      publishedAt: listing.publishedAt ?? null,\r\n      createdAt: listing.createdAt,\r\n      updatedAt: listing.updatedAt,\r\n    };\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 834, "column": 0}, "map": {"version":3,"sources":["file:///J:/projects/tree/packages/core/src/marketplace/domain/entities/Seller.ts"],"sourcesContent":["/**\r\n * Seller Entity\r\n * \r\n * Represents a seller in the marketplace.\r\n * Manages seller-specific business rules like verification, ratings, and Stripe integration.\r\n */\r\n\r\nexport interface SellerProps {\r\n  id: string;\r\n  userId: string;\r\n  businessName: string;\r\n  verified: boolean;\r\n  rating: number;\r\n  storefront?: object;\r\n  stripeAccountId?: string;\r\n  createdAt: Date;\r\n  updatedAt: Date;\r\n}\r\n\r\nexport class Seller {\r\n  private props: SellerProps;\r\n\r\n  private constructor(props: SellerProps) {\r\n    this.validateRating(props.rating);\r\n    this.validateBusinessName(props.businessName);\r\n    this.props = props;\r\n  }\r\n\r\n  /**\r\n   * Create a new seller (not yet verified)\r\n   */\r\n  public static create(props: Omit<SellerProps, 'rating' | 'verified' | 'createdAt' | 'updatedAt'>): Seller {\r\n    return new Seller({\r\n      ...props,\r\n      rating: 0,\r\n      verified: false,\r\n      createdAt: new Date(),\r\n      updatedAt: new Date(),\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Reconstitute a seller from persistence\r\n   */\r\n  public static reconstitute(props: SellerProps): Seller {\r\n    return new Seller(props);\r\n  }\r\n\r\n  private validateRating(rating: number): void {\r\n    if (rating < 0 || rating > 5) {\r\n      throw new Error('Rating must be between 0 and 5');\r\n    }\r\n  }\r\n\r\n  private validateBusinessName(name: string): void {\r\n    if (!name || name.trim().length === 0) {\r\n      throw new Error('Business name cannot be empty');\r\n    }\r\n\r\n    if (name.length < 3) {\r\n      throw new Error('Business name must be at least 3 characters');\r\n    }\r\n\r\n    if (name.length > 100) {\r\n      throw new Error('Business name cannot exceed 100 characters');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Verify the seller (after KYC/business validation)\r\n   */\r\n  public verify(): void {\r\n    if (this.props.verified) {\r\n      throw new Error('Seller is already verified');\r\n    }\r\n    this.props.verified = true;\r\n    this.props.updatedAt = new Date();\r\n  }\r\n\r\n  /**\r\n   * Unverify the seller (if fraudulent activity detected)\r\n   */\r\n  public unverify(): void {\r\n    this.props.verified = false;\r\n    this.props.updatedAt = new Date();\r\n  }\r\n\r\n  /**\r\n   * Update seller rating based on reviews\r\n   */\r\n  public updateRating(newRating: number): void {\r\n    this.validateRating(newRating);\r\n    this.props.rating = newRating;\r\n    this.props.updatedAt = new Date();\r\n  }\r\n\r\n  /**\r\n   * Connect Stripe account for payouts\r\n   */\r\n  public connectStripe(accountId: string): void {\r\n    if (!accountId || accountId.trim().length === 0) {\r\n      throw new Error('Stripe account ID is required');\r\n    }\r\n\r\n    if (!accountId.startsWith('acct_')) {\r\n      throw new Error('Invalid Stripe account ID format');\r\n    }\r\n\r\n    this.props.stripeAccountId = accountId;\r\n    this.props.updatedAt = new Date();\r\n  }\r\n\r\n  /**\r\n   * Disconnect Stripe account\r\n   */\r\n  public disconnectStripe(): void {\r\n    this.props.stripeAccountId = undefined;\r\n    this.props.updatedAt = new Date();\r\n  }\r\n\r\n  /**\r\n   * Update storefront configuration\r\n   */\r\n  public updateStorefront(storefront: object): void {\r\n    this.props.storefront = storefront;\r\n    this.props.updatedAt = new Date();\r\n  }\r\n\r\n  /**\r\n   * Check if seller can accept payments\r\n   */\r\n  public canAcceptPayments(): boolean {\r\n    return this.props.verified && !!this.props.stripeAccountId;\r\n  }\r\n\r\n  /**\r\n   * Check if seller has good standing (rating >= 3.0)\r\n   */\r\n  public hasGoodStanding(): boolean {\r\n    return this.props.rating >= 3.0;\r\n  }\r\n\r\n  // Getters\r\n  get id(): string {\r\n    return this.props.id;\r\n  }\r\n\r\n  get userId(): string {\r\n    return this.props.userId;\r\n  }\r\n\r\n  get businessName(): string {\r\n    return this.props.businessName;\r\n  }\r\n\r\n  get verified(): boolean {\r\n    return this.props.verified;\r\n  }\r\n\r\n  get rating(): number {\r\n    return this.props.rating;\r\n  }\r\n\r\n  get storefront(): object | undefined {\r\n    return this.props.storefront;\r\n  }\r\n\r\n  get stripeAccountId(): string | undefined {\r\n    return this.props.stripeAccountId;\r\n  }\r\n\r\n  get createdAt(): Date {\r\n    return this.props.createdAt;\r\n  }\r\n\r\n  get updatedAt(): Date {\r\n    return this.props.updatedAt;\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 971, "column": 0}, "map": {"version":3,"sources":["file:///J:/projects/tree/packages/core/src/marketplace/infrastructure/repositories/PrismaSellerRepository.ts"],"sourcesContent":["/**\r\n * Prisma Seller Repository Implementation\r\n * \r\n * Implements ISellerRepository using Prisma ORM.\r\n */\r\n\r\nimport { PrismaClient } from '@repo/database';\r\nimport { ISellerRepository } from '../../domain/repositories/ISellerRepository';\r\nimport { Seller } from '../../domain/entities/Seller';\r\n\r\nexport class PrismaSellerRepository implements ISellerRepository {\r\n  constructor(private prisma: PrismaClient) {}\r\n\r\n  async findById(id: string): Promise<Seller | null> {\r\n    const data = await this.prisma.seller.findUnique({\r\n      where: { id, deletedAt: null },\r\n    });\r\n\r\n    if (!data) return null;\r\n\r\n    return this.toDomain(data);\r\n  }\r\n\r\n  async findByUserId(userId: string): Promise<Seller | null> {\r\n    const data = await this.prisma.seller.findUnique({\r\n      where: { userId, deletedAt: null },\r\n    });\r\n\r\n    if (!data) return null;\r\n\r\n    return this.toDomain(data);\r\n  }\r\n\r\n  async findByStripeAccountId(stripeAccountId: string): Promise<Seller | null> {\r\n    const data = await this.prisma.seller.findFirst({\r\n      where: { \r\n        stripeAccountId,\r\n        deletedAt: null,\r\n      },\r\n    });\r\n\r\n    if (!data) return null;\r\n\r\n    return this.toDomain(data);\r\n  }\r\n\r\n  async findVerified(): Promise<Seller[]> {\r\n    const data = await this.prisma.seller.findMany({\r\n      where: { \r\n        verified: true,\r\n        deletedAt: null,\r\n      },\r\n      orderBy: { rating: 'desc' },\r\n    });\r\n\r\n    return data.map(d => this.toDomain(d));\r\n  }\r\n\r\n  async findByMinimumRating(rating: number): Promise<Seller[]> {\r\n    const data = await this.prisma.seller.findMany({\r\n      where: { \r\n        rating: { gte: rating },\r\n        deletedAt: null,\r\n      },\r\n      orderBy: { rating: 'desc' },\r\n    });\r\n\r\n    return data.map(d => this.toDomain(d));\r\n  }\r\n\r\n  async save(seller: Seller): Promise<void> {\r\n    const data = this.toPersistence(seller);\r\n\r\n    await this.prisma.seller.upsert({\r\n      where: { id: seller.id },\r\n      create: data,\r\n      update: {\r\n        businessName: data.businessName,\r\n        verified: data.verified,\r\n        rating: data.rating,\r\n        storefront: data.storefront,\r\n        stripeAccountId: data.stripeAccountId,\r\n        updatedAt: data.updatedAt,\r\n      },\r\n    });\r\n  }\r\n\r\n  async delete(id: string): Promise<void> {\r\n    await this.prisma.seller.update({\r\n      where: { id },\r\n      data: { deletedAt: new Date() },\r\n    });\r\n  }\r\n\r\n  async count(): Promise<number> {\r\n    return this.prisma.seller.count({\r\n      where: { deletedAt: null },\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Convert Prisma model to Domain entity\r\n   */\r\n  private toDomain(data: any): Seller {\r\n    return Seller.reconstitute({\r\n      id: data.id,\r\n      userId: data.userId,\r\n      businessName: data.businessName,\r\n      verified: data.verified,\r\n      rating: data.rating,\r\n      storefront: data.storefront as object | undefined,\r\n      stripeAccountId: data.stripeAccountId ?? undefined,\r\n      createdAt: data.createdAt,\r\n      updatedAt: data.updatedAt,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Convert Domain entity to Prisma model data\r\n   */\r\n  private toPersistence(seller: Seller): any {\r\n    return {\r\n      id: seller.id,\r\n      userId: seller.userId,\r\n      businessName: seller.businessName,\r\n      verified: seller.verified,\r\n      rating: seller.rating,\r\n      storefront: seller.storefront ?? null,\r\n      stripeAccountId: seller.stripeAccountId ?? null,\r\n      createdAt: seller.createdAt,\r\n      updatedAt: seller.updatedAt,\r\n    };\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1135, "column": 0}, "map": {"version":3,"sources":["file:///J:/projects/tree/packages/core/src/identity/domain/value-objects/AccessToken.ts"],"sourcesContent":["/**\r\n * AccessToken Value Object\r\n * \r\n * Encapsulates JWT access token logic.\r\n * Short-lived token for API authentication (15 minutes).\r\n */\r\n\r\nimport jwt from 'jsonwebtoken';\r\n\r\nexport interface AccessTokenPayload {\r\n  userId: string;\r\n  email: string;\r\n  role: string;\r\n}\r\n\r\nexport class AccessToken {\r\n  private readonly token: string;\r\n  private static readonly EXPIRY = '15m'; // 15 minutes\r\n  private static readonly SECRET = process.env.JWT_ACCESS_SECRET || 'default-access-secret-change-in-production';\r\n\r\n  private constructor(token: string) {\r\n    this.token = token;\r\n  }\r\n\r\n  /**\r\n   * Generate a new access token\r\n   */\r\n  public static generate(payload: AccessTokenPayload): AccessToken {\r\n    const token = jwt.sign(\r\n      payload,\r\n      AccessToken.SECRET,\r\n      {\r\n        expiresIn: AccessToken.EXPIRY,\r\n        issuer: 'treeverse-api',\r\n        audience: 'treeverse-client',\r\n      }\r\n    );\r\n\r\n    return new AccessToken(token);\r\n  }\r\n\r\n  /**\r\n   * Verify and decode an access token\r\n   */\r\n  public static verify(token: string): AccessTokenPayload {\r\n    try {\r\n      const decoded = jwt.verify(token, AccessToken.SECRET, {\r\n        issuer: 'treeverse-api',\r\n        audience: 'treeverse-client',\r\n      }) as AccessTokenPayload;\r\n\r\n      return decoded;\r\n    } catch (error) {\r\n      if (error instanceof jwt.TokenExpiredError) {\r\n        throw new Error('Access token has expired');\r\n      }\r\n      if (error instanceof jwt.JsonWebTokenError) {\r\n        throw new Error('Invalid access token');\r\n      }\r\n      throw new Error('Access token verification failed');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Create from existing token string (for verification)\r\n   */\r\n  public static fromString(token: string): AccessToken {\r\n    // Verify the token is valid before creating the value object\r\n    AccessToken.verify(token);\r\n    return new AccessToken(token);\r\n  }\r\n\r\n  /**\r\n   * Get the token string\r\n   */\r\n  public getValue(): string {\r\n    return this.token;\r\n  }\r\n\r\n  /**\r\n   * Check if token is expired\r\n   */\r\n  public isExpired(): boolean {\r\n    try {\r\n      jwt.verify(this.token, AccessToken.SECRET);\r\n      return false;\r\n    } catch (error) {\r\n      if (error instanceof jwt.TokenExpiredError) {\r\n        return true;\r\n      }\r\n      return false;\r\n    }\r\n  }\r\n}\r\n"],"names":[],"mappings":"AAAA;;;;;CAKC;;;;AAED;;AAQO,MAAM;IACM,MAAc;IAC/B,OAAwB,SAAS,MAAM;IACvC,OAAwB,SAAS,QAAQ,GAAG,CAAC,iBAAiB,IAAI,6CAA6C;IAE/G,YAAoB,KAAa,CAAE;QACjC,IAAI,CAAC,KAAK,GAAG;IACf;IAEA;;GAEC,GACD,OAAc,SAAS,OAA2B,EAAe;QAC/D,MAAM,QAAQ,2MAAG,CAAC,IAAI,CACpB,SACA,YAAY,MAAM,EAClB;YACE,WAAW,YAAY,MAAM;YAC7B,QAAQ;YACR,UAAU;QACZ;QAGF,OAAO,IAAI,YAAY;IACzB;IAEA;;GAEC,GACD,OAAc,OAAO,KAAa,EAAsB;QACtD,IAAI;YACF,MAAM,UAAU,2MAAG,CAAC,MAAM,CAAC,OAAO,YAAY,MAAM,EAAE;gBACpD,QAAQ;gBACR,UAAU;YACZ;YAEA,OAAO;QACT,EAAE,OAAO,OAAO;YACd,IAAI,iBAAiB,2MAAG,CAAC,iBAAiB,EAAE;gBAC1C,MAAM,IAAI,MAAM;YAClB;YACA,IAAI,iBAAiB,2MAAG,CAAC,iBAAiB,EAAE;gBAC1C,MAAM,IAAI,MAAM;YAClB;YACA,MAAM,IAAI,MAAM;QAClB;IACF;IAEA;;GAEC,GACD,OAAc,WAAW,KAAa,EAAe;QACnD,6DAA6D;QAC7D,YAAY,MAAM,CAAC;QACnB,OAAO,IAAI,YAAY;IACzB;IAEA;;GAEC,GACD,AAAO,WAAmB;QACxB,OAAO,IAAI,CAAC,KAAK;IACnB;IAEA;;GAEC,GACD,AAAO,YAAqB;QAC1B,IAAI;YACF,2MAAG,CAAC,MAAM,CAAC,IAAI,CAAC,KAAK,EAAE,YAAY,MAAM;YACzC,OAAO;QACT,EAAE,OAAO,OAAO;YACd,IAAI,iBAAiB,2MAAG,CAAC,iBAAiB,EAAE;gBAC1C,OAAO;YACT;YACA,OAAO;QACT;IACF;AACF"}},
    {"offset": {"line": 1212, "column": 0}, "map": {"version":3,"sources":["file:///J:/projects/tree/packages/core/src/identity/domain/value-objects/RefreshToken.ts"],"sourcesContent":["/**\r\n * RefreshToken Value Object\r\n * \r\n * Encapsulates JWT refresh token logic.\r\n * Long-lived token for obtaining new access tokens (7 days).\r\n */\r\n\r\nimport jwt from 'jsonwebtoken';\r\nimport { randomBytes } from 'crypto';\r\n\r\nexport interface RefreshTokenPayload {\r\n  userId: string;\r\n  tokenId: string; // Unique ID for token rotation/revocation\r\n}\r\n\r\nexport class RefreshToken {\r\n  private readonly token: string;\r\n  private static readonly EXPIRY = '7d'; // 7 days\r\n  private static readonly SECRET = process.env.JWT_REFRESH_SECRET || 'default-refresh-secret-change-in-production';\r\n\r\n  private constructor(token: string) {\r\n    this.token = token;\r\n  }\r\n\r\n  /**\r\n   * Generate a new refresh token\r\n   */\r\n  public static generate(userId: string): RefreshToken {\r\n    const tokenId = RefreshToken.generateTokenId();\r\n\r\n    const token = jwt.sign(\r\n      { userId, tokenId } as RefreshTokenPayload,\r\n      RefreshToken.SECRET,\r\n      {\r\n        expiresIn: RefreshToken.EXPIRY,\r\n        issuer: 'treeverse-api',\r\n        audience: 'treeverse-client',\r\n      }\r\n    );\r\n\r\n    return new RefreshToken(token);\r\n  }\r\n\r\n  /**\r\n   * Verify and decode a refresh token\r\n   */\r\n  public static verify(token: string): RefreshTokenPayload {\r\n    try {\r\n      const decoded = jwt.verify(token, RefreshToken.SECRET, {\r\n        issuer: 'treeverse-api',\r\n        audience: 'treeverse-client',\r\n      }) as RefreshTokenPayload;\r\n\r\n      return decoded;\r\n    } catch (error) {\r\n      if (error instanceof jwt.TokenExpiredError) {\r\n        throw new Error('Refresh token has expired');\r\n      }\r\n      if (error instanceof jwt.JsonWebTokenError) {\r\n        throw new Error('Invalid refresh token');\r\n      }\r\n      throw new Error('Refresh token verification failed');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Create from existing token string (for verification)\r\n   */\r\n  public static fromString(token: string): RefreshToken {\r\n    // Verify the token is valid before creating the value object\r\n    RefreshToken.verify(token);\r\n    return new RefreshToken(token);\r\n  }\r\n\r\n  /**\r\n   * Generate a unique token ID for tracking/revocation\r\n   */\r\n  private static generateTokenId(): string {\r\n    return randomBytes(16).toString('hex');\r\n  }\r\n\r\n  /**\r\n   * Get the token string\r\n   */\r\n  public getValue(): string {\r\n    return this.token;\r\n  }\r\n\r\n  /**\r\n   * Get the token ID from the token\r\n   */\r\n  public getTokenId(): string {\r\n    const payload = RefreshToken.verify(this.token);\r\n    return payload.tokenId;\r\n  }\r\n\r\n  /**\r\n   * Get the user ID from the token\r\n   */\r\n  public getUserId(): string {\r\n    const payload = RefreshToken.verify(this.token);\r\n    return payload.userId;\r\n  }\r\n\r\n  /**\r\n   * Check if token is expired\r\n   */\r\n  public isExpired(): boolean {\r\n    try {\r\n      jwt.verify(this.token, RefreshToken.SECRET);\r\n      return false;\r\n    } catch (error) {\r\n      if (error instanceof jwt.TokenExpiredError) {\r\n        return true;\r\n      }\r\n      return false;\r\n    }\r\n  }\r\n}\r\n"],"names":[],"mappings":"AAAA;;;;;CAKC;;;;AAED;AACA;;;AAOO,MAAM;IACM,MAAc;IAC/B,OAAwB,SAAS,KAAK;IACtC,OAAwB,SAAS,QAAQ,GAAG,CAAC,kBAAkB,IAAI,8CAA8C;IAEjH,YAAoB,KAAa,CAAE;QACjC,IAAI,CAAC,KAAK,GAAG;IACf;IAEA;;GAEC,GACD,OAAc,SAAS,MAAc,EAAgB;QACnD,MAAM,UAAU,aAAa,eAAe;QAE5C,MAAM,QAAQ,2MAAG,CAAC,IAAI,CACpB;YAAE;YAAQ;QAAQ,GAClB,aAAa,MAAM,EACnB;YACE,WAAW,aAAa,MAAM;YAC9B,QAAQ;YACR,UAAU;QACZ;QAGF,OAAO,IAAI,aAAa;IAC1B;IAEA;;GAEC,GACD,OAAc,OAAO,KAAa,EAAuB;QACvD,IAAI;YACF,MAAM,UAAU,2MAAG,CAAC,MAAM,CAAC,OAAO,aAAa,MAAM,EAAE;gBACrD,QAAQ;gBACR,UAAU;YACZ;YAEA,OAAO;QACT,EAAE,OAAO,OAAO;YACd,IAAI,iBAAiB,2MAAG,CAAC,iBAAiB,EAAE;gBAC1C,MAAM,IAAI,MAAM;YAClB;YACA,IAAI,iBAAiB,2MAAG,CAAC,iBAAiB,EAAE;gBAC1C,MAAM,IAAI,MAAM;YAClB;YACA,MAAM,IAAI,MAAM;QAClB;IACF;IAEA;;GAEC,GACD,OAAc,WAAW,KAAa,EAAgB;QACpD,6DAA6D;QAC7D,aAAa,MAAM,CAAC;QACpB,OAAO,IAAI,aAAa;IAC1B;IAEA;;GAEC,GACD,OAAe,kBAA0B;QACvC,OAAO,IAAA,oHAAW,EAAC,IAAI,QAAQ,CAAC;IAClC;IAEA;;GAEC,GACD,AAAO,WAAmB;QACxB,OAAO,IAAI,CAAC,KAAK;IACnB;IAEA;;GAEC,GACD,AAAO,aAAqB;QAC1B,MAAM,UAAU,aAAa,MAAM,CAAC,IAAI,CAAC,KAAK;QAC9C,OAAO,QAAQ,OAAO;IACxB;IAEA;;GAEC,GACD,AAAO,YAAoB;QACzB,MAAM,UAAU,aAAa,MAAM,CAAC,IAAI,CAAC,KAAK;QAC9C,OAAO,QAAQ,MAAM;IACvB;IAEA;;GAEC,GACD,AAAO,YAAqB;QAC1B,IAAI;YACF,2MAAG,CAAC,MAAM,CAAC,IAAI,CAAC,KAAK,EAAE,aAAa,MAAM;YAC1C,OAAO;QACT,EAAE,OAAO,OAAO;YACd,IAAI,iBAAiB,2MAAG,CAAC,iBAAiB,EAAE;gBAC1C,OAAO;YACT;YACA,OAAO;QACT;IACF;AACF"}},
    {"offset": {"line": 1312, "column": 0}, "map": {"version":3,"sources":["file:///J:/projects/tree/packages/core/src/identity/domain/services/TokenService.ts"],"sourcesContent":["/**\r\n * TokenService\r\n * \r\n * Domain service for managing authentication tokens.\r\n * Handles token generation, verification, and refresh.\r\n */\r\n\r\nimport { AccessToken, AccessTokenPayload } from '../value-objects/AccessToken';\r\nimport { RefreshToken } from '../value-objects/RefreshToken';\r\n\r\nexport interface TokenPair {\r\n  accessToken: string;\r\n  refreshToken: string;\r\n}\r\n\r\nexport class TokenService {\r\n  /**\r\n   * Generate a new token pair (access + refresh)\r\n   */\r\n  public generateTokenPair(userId: string, email: string, role: string): TokenPair {\r\n    const accessTokenPayload: AccessTokenPayload = {\r\n      userId,\r\n      email,\r\n      role,\r\n    };\r\n\r\n    const accessToken = AccessToken.generate(accessTokenPayload);\r\n    const refreshToken = RefreshToken.generate(userId);\r\n\r\n    return {\r\n      accessToken: accessToken.getValue(),\r\n      refreshToken: refreshToken.getValue(),\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Verify an access token\r\n   */\r\n  public verifyAccessToken(token: string): AccessTokenPayload {\r\n    return AccessToken.verify(token);\r\n  }\r\n\r\n  /**\r\n   * Verify a refresh token\r\n   */\r\n  public verifyRefreshToken(token: string): { userId: string; tokenId: string } {\r\n    return RefreshToken.verify(token);\r\n  }\r\n\r\n  /**\r\n   * Refresh tokens - generate new pair from valid refresh token\r\n   */\r\n  public refreshTokens(\r\n    refreshTokenString: string,\r\n    email: string,\r\n    role: string\r\n  ): TokenPair {\r\n    // Verify the refresh token\r\n    const refreshToken = RefreshToken.fromString(refreshTokenString);\r\n    const userId = refreshToken.getUserId();\r\n\r\n    // Generate new token pair\r\n    return this.generateTokenPair(userId, email, role);\r\n  }\r\n\r\n  /**\r\n   * Extract token from Authorization header\r\n   */\r\n  public extractTokenFromHeader(authHeader: string | null): string | null {\r\n    if (!authHeader) {\r\n      return null;\r\n    }\r\n\r\n    // Expected format: \"Bearer <token>\"\r\n    const parts = authHeader.split(' ');\r\n\r\n    if (parts.length !== 2 || parts[0] !== 'Bearer') {\r\n      return null;\r\n    }\r\n\r\n    return parts[1];\r\n  }\r\n}\r\n"],"names":[],"mappings":"AAAA;;;;;CAKC;;;;AAED;AACA;;;AAOO,MAAM;IACX;;GAEC,GACD,AAAO,kBAAkB,MAAc,EAAE,KAAa,EAAE,IAAY,EAAa;QAC/E,MAAM,qBAAyC;YAC7C;YACA;YACA;QACF;QAEA,MAAM,cAAc,iMAAW,CAAC,QAAQ,CAAC;QACzC,MAAM,eAAe,mMAAY,CAAC,QAAQ,CAAC;QAE3C,OAAO;YACL,aAAa,YAAY,QAAQ;YACjC,cAAc,aAAa,QAAQ;QACrC;IACF;IAEA;;GAEC,GACD,AAAO,kBAAkB,KAAa,EAAsB;QAC1D,OAAO,iMAAW,CAAC,MAAM,CAAC;IAC5B;IAEA;;GAEC,GACD,AAAO,mBAAmB,KAAa,EAAuC;QAC5E,OAAO,mMAAY,CAAC,MAAM,CAAC;IAC7B;IAEA;;GAEC,GACD,AAAO,cACL,kBAA0B,EAC1B,KAAa,EACb,IAAY,EACD;QACX,2BAA2B;QAC3B,MAAM,eAAe,mMAAY,CAAC,UAAU,CAAC;QAC7C,MAAM,SAAS,aAAa,SAAS;QAErC,0BAA0B;QAC1B,OAAO,IAAI,CAAC,iBAAiB,CAAC,QAAQ,OAAO;IAC/C;IAEA;;GAEC,GACD,AAAO,uBAAuB,UAAyB,EAAiB;QACtE,IAAI,CAAC,YAAY;YACf,OAAO;QACT;QAEA,oCAAoC;QACpC,MAAM,QAAQ,WAAW,KAAK,CAAC;QAE/B,IAAI,MAAM,MAAM,KAAK,KAAK,KAAK,CAAC,EAAE,KAAK,UAAU;YAC/C,OAAO;QACT;QAEA,OAAO,KAAK,CAAC,EAAE;IACjB;AACF"}},
    {"offset": {"line": 1378, "column": 0}, "map": {"version":3,"sources":["file:///J:/projects/tree/apps/web/lib/middleware/auth.ts"],"sourcesContent":["/**\r\n * Authentication Middleware\r\n * \r\n * Verifies JWT tokens and attaches user information to requests.\r\n */\r\n\r\nimport { NextRequest } from 'next/server';\r\nimport { TokenService } from '@repo/core/identity/domain/services/TokenService';\r\n\r\nexport interface AuthenticatedRequest extends NextRequest {\r\n  user?: {\r\n    userId: string;\r\n    email: string;\r\n    role: string;\r\n  };\r\n}\r\n\r\n/**\r\n * Extract and verify JWT token from request\r\n */\r\nexport async function authenticateRequest(\r\n  request: NextRequest\r\n): Promise<{ userId: string; email: string; role: string }> {\r\n  const tokenService = new TokenService();\r\n\r\n  // Extract token from Authorization header\r\n  const authHeader = request.headers.get('Authorization');\r\n  const token = tokenService.extractTokenFromHeader(authHeader);\r\n\r\n  if (!token) {\r\n    throw new Error('No authentication token provided');\r\n  }\r\n\r\n  // Verify token\r\n  try {\r\n    const payload = tokenService.verifyAccessToken(token);\r\n\r\n    return {\r\n      userId: payload.userId,\r\n      email: payload.email,\r\n      role: payload.role,\r\n    };\r\n  } catch (error) {\r\n    console.error('Auth Middleware Error:', error);\r\n    // Debug: Check if secret is loaded\r\n    if (!process.env.JWT_SECRET) {\r\n      console.error('CRITICAL: JWT_SECRET is missing in environment variables!');\r\n    }\r\n\r\n    if (error instanceof Error) {\r\n      throw new Error(`Authentication failed: ${error.message}`);\r\n    }\r\n    throw new Error('Authentication failed');\r\n  }\r\n}\r\n\r\n/**\r\n * Middleware to require specific roles\r\n */\r\nexport function requireRole(allowedRoles: string[]) {\r\n  return async (request: AuthenticatedRequest) => {\r\n    const user = await authenticateRequest(request);\r\n\r\n    if (!allowedRoles.includes(user.role)) {\r\n      console.error(`Role mismatch: User role '${user.role}' is not in allowed roles: ${allowedRoles.join(', ')}`);\r\n      throw new Error(\r\n        `Forbidden: Requires one of the following roles: ${allowedRoles.join(', ')}`\r\n      );\r\n    }\r\n\r\n    return user;\r\n  };\r\n}\r\n\r\n/**\r\n * Common role checks\r\n */\r\nexport const requireAdmin = requireRole(['ADMIN']);\r\nexport const requireSeller = requireRole(['SELLER', 'ADMIN']);\r\nexport const requireAuthenticated = authenticateRequest;\r\n"],"names":[],"mappings":"AAAA;;;;CAIC;;;;;;;;;;;;AAGD;;AAaO,eAAe,oBACpB,OAAoB;IAEpB,MAAM,eAAe,IAAI,2LAAY;IAErC,0CAA0C;IAC1C,MAAM,aAAa,QAAQ,OAAO,CAAC,GAAG,CAAC;IACvC,MAAM,QAAQ,aAAa,sBAAsB,CAAC;IAElD,IAAI,CAAC,OAAO;QACV,MAAM,IAAI,MAAM;IAClB;IAEA,eAAe;IACf,IAAI;QACF,MAAM,UAAU,aAAa,iBAAiB,CAAC;QAE/C,OAAO;YACL,QAAQ,QAAQ,MAAM;YACtB,OAAO,QAAQ,KAAK;YACpB,MAAM,QAAQ,IAAI;QACpB;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,0BAA0B;QACxC,mCAAmC;QACnC,IAAI,CAAC,QAAQ,GAAG,CAAC,UAAU,EAAE;YAC3B,QAAQ,KAAK,CAAC;QAChB;QAEA,IAAI,iBAAiB,OAAO;YAC1B,MAAM,IAAI,MAAM,CAAC,uBAAuB,EAAE,MAAM,OAAO,EAAE;QAC3D;QACA,MAAM,IAAI,MAAM;IAClB;AACF;AAKO,SAAS,YAAY,YAAsB;IAChD,OAAO,OAAO;QACZ,MAAM,OAAO,MAAM,oBAAoB;QAEvC,IAAI,CAAC,aAAa,QAAQ,CAAC,KAAK,IAAI,GAAG;YACrC,QAAQ,KAAK,CAAC,CAAC,0BAA0B,EAAE,KAAK,IAAI,CAAC,2BAA2B,EAAE,aAAa,IAAI,CAAC,OAAO;YAC3G,MAAM,IAAI,MACR,CAAC,gDAAgD,EAAE,aAAa,IAAI,CAAC,OAAO;QAEhF;QAEA,OAAO;IACT;AACF;AAKO,MAAM,eAAe,YAAY;IAAC;CAAQ;AAC1C,MAAM,gBAAgB,YAAY;IAAC;IAAU;CAAQ;AACrD,MAAM,uBAAuB"}},
    {"offset": {"line": 1446, "column": 0}, "map": {"version":3,"sources":["file:///J:/projects/tree/apps/web/app/api/v1/listings/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\r\nimport { z } from 'zod';\r\nimport { prisma } from '@repo/database';\r\nimport { CreateListingUseCase } from '@repo/core/marketplace/application/use-cases/CreateListingUseCase';\r\nimport { SearchListingsUseCase } from '@repo/core/marketplace/application/use-cases/SearchListingsUseCase';\r\nimport { PrismaListingRepository } from '@repo/core/marketplace/infrastructure/repositories/PrismaListingRepository';\r\nimport { PrismaSellerRepository } from '@repo/core/marketplace/infrastructure/repositories/PrismaSellerRepository';\r\nimport { requireSeller } from '@/lib/middleware/auth';\r\n\r\n// Validation Schemas\r\nconst CreateListingSchema = z.object({\r\n  speciesId: z.string().uuid('Invalid species ID format'),\r\n  title: z.string().min(10, 'Title must be at least 10 characters').max(200, 'Title cannot exceed 200 characters'),\r\n  description: z.string().min(50, 'Description must be at least 50 characters'),\r\n  basePrice: z.number().positive('Price must be positive'),\r\n  inventory: z.number().int().min(0, 'Inventory cannot be negative'),\r\n  metadata: z.object({}).optional(),\r\n});\r\n\r\nconst SearchListingsSchema = z.object({\r\n  speciesId: z.string().uuid().optional(),\r\n  sellerId: z.string().uuid().optional(),\r\n  status: z.enum(['DRAFT', 'ACTIVE', 'SOLD_OUT', 'FLAGGED', 'ARCHIVED']).optional(),\r\n  minPrice: z.number().positive().optional(),\r\n  maxPrice: z.number().positive().optional(),\r\n  searchTerm: z.string().optional(),\r\n  page: z.number().int().positive().optional(),\r\n  pageSize: z.number().int().positive().max(100).optional(),\r\n});\r\n\r\n// Handle CORS preflight\r\nexport async function OPTIONS() {\r\n  return new NextResponse(null, { status: 200 });\r\n}\r\n\r\n/**\r\n * POST /api/v1/listings\r\n * Create a new listing (PROTECTED - Requires SELLER role)\r\n */\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    // 1. Authenticate and check role\r\n    // 1. Authenticate and check role\r\n    const authenticatedUser = await requireSeller(request);\r\n    console.log('User authenticated for create listing:', authenticatedUser);\r\n\r\n    // 2. Parse and validate request body\r\n    const body = await request.json();\r\n    const validatedData = CreateListingSchema.parse(body);\r\n\r\n    // 3. Initialize repositories and use case\r\n    const listingRepository = new PrismaListingRepository(prisma);\r\n    const sellerRepository = new PrismaSellerRepository(prisma);\r\n    const useCase = new CreateListingUseCase(listingRepository, sellerRepository);\r\n\r\n    // 4. Execute use case with authenticated user's ID\r\n    const result = await useCase.execute({\r\n      ...validatedData,\r\n      sellerId: authenticatedUser.userId, // Use authenticated user's ID, not from request body\r\n    });\r\n\r\n    // 5. Return success response\r\n    return NextResponse.json(\r\n      {\r\n        success: true,\r\n        data: result,\r\n        message: 'Listing created successfully',\r\n      },\r\n      { status: 201 }\r\n    );\r\n  } catch (error) {\r\n    // Handle authentication errors\r\n    if (error instanceof Error && error.message.includes('Authentication')) {\r\n      return NextResponse.json(\r\n        {\r\n          success: false,\r\n          error: error.message,\r\n        },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    return handleError(error);\r\n  }\r\n}\r\n\r\n/**\r\n * GET /api/v1/listings\r\n * Search listings with filters\r\n */\r\nexport async function GET(request: NextRequest) {\r\n  try {\r\n    // 1. Parse query parameters\r\n    const searchParams = request.nextUrl.searchParams;\r\n\r\n    const queryData = {\r\n      speciesId: searchParams.get('speciesId') || undefined,\r\n      sellerId: searchParams.get('sellerId') || undefined,\r\n      status: searchParams.get('status')?.toUpperCase() || undefined,\r\n      minPrice: searchParams.get('minPrice') ? parseFloat(searchParams.get('minPrice')!) : undefined,\r\n      maxPrice: searchParams.get('maxPrice') ? parseFloat(searchParams.get('maxPrice')!) : undefined,\r\n      searchTerm: searchParams.get('searchTerm') || undefined,\r\n      page: searchParams.get('page') ? parseInt(searchParams.get('page')!) : undefined,\r\n      pageSize: searchParams.get('pageSize') ? parseInt(searchParams.get('pageSize')!) : undefined,\r\n    };\r\n\r\n    // 2. Validate query parameters\r\n    const validatedData = SearchListingsSchema.parse(queryData);\r\n\r\n    // 3. Initialize repository and use case\r\n    const listingRepository = new PrismaListingRepository(prisma);\r\n    const useCase = new SearchListingsUseCase(listingRepository);\r\n\r\n    // 4. Execute use case\r\n    const result = await useCase.execute(validatedData);\r\n\r\n    // 5. Return success response\r\n    return NextResponse.json({\r\n      success: true,\r\n      data: result,\r\n    });\r\n  } catch (error) {\r\n    return handleError(error);\r\n  }\r\n}\r\n\r\n/**\r\n * Centralized error handler\r\n */\r\nfunction handleError(error: unknown): NextResponse {\r\n  // Validation errors (Zod)\r\n  if (error instanceof z.ZodError) {\r\n    return NextResponse.json(\r\n      {\r\n        success: false,\r\n        error: 'Validation failed',\r\n        details: error.errors.map(err => ({\r\n          field: err.path.join('.'),\r\n          message: err.message,\r\n        })),\r\n      },\r\n      { status: 400 }\r\n    );\r\n  }\r\n\r\n  // Business logic errors\r\n  if (error instanceof Error) {\r\n    // Check for specific error messages\r\n    if (error.message.includes('not found')) {\r\n      return NextResponse.json(\r\n        {\r\n          success: false,\r\n          error: error.message,\r\n        },\r\n        { status: 404 }\r\n      );\r\n    }\r\n\r\n    if (error.message.includes('Only verified sellers')) {\r\n      return NextResponse.json(\r\n        {\r\n          success: false,\r\n          error: error.message,\r\n        },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    // Generic business error\r\n    return NextResponse.json(\r\n      {\r\n        success: false,\r\n        error: error.message,\r\n      },\r\n      { status: 400 }\r\n    );\r\n  }\r\n\r\n  // Unknown error\r\n  console.error('Unexpected error:', error);\r\n  return NextResponse.json(\r\n    {\r\n      success: false,\r\n      error: 'Internal server error',\r\n    },\r\n    { status: 500 }\r\n  );\r\n}\r\n"],"names":[],"mappings":"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"}}]
}